<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tma-primary': '#007AFF',
                        'tma-bg': '#f5f5f5',
                        'tma-card': '#ffffff',
                        'tma-red': '#FF3B30',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'tma-nav': '0 -4px 6px -1px rgba(0, 0, 0, 0.05), 0 -2px 4px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Общие стили для контейнера приложения */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5; /* tma-bg fallback */
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }
        /* Стили для переключения видов (Slider) */
        #main-app-container {
            display: flex;
            transition: transform 0.3s ease-in-out;
            width: 400%; /* 4 views */
            height: 100%;
        }
        .view-container {
            flex-shrink: 0;
            width: 25%; /* 100% / 4 views */
            height: 100%;
            overflow-y: auto;
        }
        /* Стили для всплывающего окна комментариев */
        #comments-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5; /* tma-bg fallback */
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        #comments-view.show-comments {
            transform: translateY(0);
        }
        #comment-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column-reverse; /* Новые комментарии вверху */
        }
        /* Стили для лоадера видео */
        #video-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 0.75rem; /* rounded-xl */
        }
        /* Анимация спиннера */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #007AFF; /* tma-primary */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Стили для всплывающих сообщений */
        #message-container {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 500;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-tma-bg">

    <div id="app-container">

        <header class="bg-tma-card shadow-sm p-4 flex items-center justify-between flex-shrink-0">
            <button id="header-back-button" onclick="navigateBack()" class="text-tma-primary hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 id="header-title" class="text-lg font-bold text-gray-800 flex-grow text-center">Главная</h1>
        </header>

        <div id="message-container" class="rounded-lg text-white p-3 shadow-lg">
            <p id="message-text" class="text-sm"></p>
        </div>

        <div id="splash-screen" class="absolute inset-0 bg-tma-bg flex flex-col items-center justify-center z-40">
            <div class="spinner"></div>
            <p class="text-gray-500 mt-4">Загрузка платформы...</p>
        </div>
        
        <div id="registration-view" class="p-8 bg-tma-bg flex flex-col items-center justify-center h-full w-full absolute inset-0 z-40 hidden">
             <h2 class="text-2xl font-bold mb-4">Выберите юзернейм</h2>
             <p class="text-gray-600 mb-6 text-center">Это имя будет отображаться рядом с вашими комментариями.</p>
             <input id="username-input" type="text" placeholder="Мой юзернейм" class="w-full max-w-sm p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-tma-primary">
             <button onclick="registerUsername()" class="w-full max-w-sm mt-4 p-3 bg-tma-primary text-white font-semibold rounded-lg hover:bg-tma-primary/90 transition">
                 Сохранить и войти
             </button>
        </div>


        <div id="main-app-container" class="flex-grow">
            
            <div id="home-view" class="view-container bg-tma-bg">
                <div id="video-feed" class="flex-shrink-0 w-full h-full p-4">
                    
                    <div class="bg-tma-card rounded-xl shadow-lg p-4 relative">
                        <div id="video-loading-overlay" class="rounded-xl">
                            <div class="spinner"></div>
                            <p class="text-gray-500 mt-4">Загрузка данных...</p>
                        </div>

                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="bg-tma-primary w-10 h-10 rounded-full flex items-center justify-center text-white font-bold">W2</div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-800">Why2 Platform</p>
                                    <span id="video-date" class="text-xs text-gray-500"></span> 
                                </div>
                            </div>
                            <button onclick="switchView('profile')" class="text-tma-primary text-sm font-semibold py-1 px-3 border border-tma-primary rounded-full hover:bg-tma-primary/10 transition">
                                Профиль
                            </button>
                        </div>
                        
                        <div class="relative w-full aspect-[9/16] bg-gray-900 rounded-lg overflow-hidden mb-3">
                            <img src="https://placehold.co/400x711/007AFF/ffffff?text=Video+Content+Placeholder" alt="Video thumbnail" class="w-full h-full object-cover">
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/50 to-transparent p-3">
                                <p class="text-white text-base">
                                    Привет! Это пилотный запуск нашей новой платформы с облачной базой данных Supabase. Ставьте лайк, если вам нравится!
                                </p>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div id="like-widget" onclick="toggleLike()" class="flex items-center space-x-1 cursor-pointer select-none text-gray-600 hover:text-tma-primary transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                </svg>
                                <span id="like-count" class="font-semibold text-sm">0</span>
                                <span class="text-sm">Лайков</span>
                            </div>
                            <div onclick="openCommentsView()" class="flex items-center space-x-1 cursor-pointer select-none text-gray-600 hover:text-tma-primary transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M16 12a2 2 0 11-4 0 2 2 0 014 0zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span id="comment-count" class="font-semibold text-sm">0</span>
                                <span class="text-sm">Комментариев</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 text-center mt-4">
                        Video ID: <span id="video-id-display">N/A</span>. Error: <span id="error-message" class="text-tma-red hidden">DB Connection Failed (Limited Mode)</span>
                    </p>

                </div>
            </div>

            <div id="post-view" class="view-container bg-tma-bg">
                <div class="p-4">
                    <h2 class="text-2xl font-bold mb-4">Загрузить Видео (Mock)</h2>
                    <p class="text-gray-600 mb-6">В этой секции происходит процесс загрузки видеоконтента.</p>
                    
                    <form onsubmit="event.preventDefault(); publishVideo()">
                        <div class="mb-4">
                            <label for="caption-input" class="block text-sm font-medium text-gray-700 mb-1">Описание видео</label>
                            <textarea id="caption-input" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-tma-primary" placeholder="Расскажите о вашем видео..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="file-upload" class="block text-sm font-medium text-gray-700 mb-1">Выбрать файл (Mock)</label>
                            <input id="file-upload" type="file" class="w-full text-gray-500" disabled>
                        </div>
                        <button type="submit" class="w-full p-3 bg-tma-primary text-white font-semibold rounded-lg hover:bg-tma-primary/90 transition">
                            Опубликовать (Модель)
                        </button>
                    </form>
                </div>
            </div>

            <div id="profile-view" class="view-container bg-tma-bg">
                <div class="p-6 text-center">
                    <div class="bg-gray-200 w-24 h-24 rounded-full mx-auto flex items-center justify-center text-tma-primary text-4xl font-bold mb-4">W2</div>
                    <h2 id="profile-username" class="text-2xl font-bold text-gray-800">Username</h2>
                    <p id="profile-user-id" class="text-gray-500 text-sm mt-1">ID: N/A</p>
                    
                    <div class="mt-6 bg-tma-card rounded-xl shadow-md p-4 text-left">
                        <h3 class="font-semibold text-gray-800 mb-3">Статус аккаунта</h3>
                        <p id="verification-status" class="text-gray-500 mb-2">⚪ Не верифицирован</p>
                        <div id="ban-status" class="text-tma-red font-semibold bg-red-100 p-2 rounded-lg mt-2 hidden">
                            🚫 Ваш аккаунт забанен.
                        </div>
                    </div>

                    <div class="mt-6 bg-tma-card rounded-xl shadow-md p-4 text-left">
                        <h3 class="font-semibold text-gray-800 mb-3">Техническая информация</h3>
                        <p class="text-sm text-gray-600">Система базы данных: Supabase</p>
                        <p class="text-sm text-gray-600">Telegram App ID: <span class="break-all" id="admin-user-id-display">N/A</span></p>
                    </div>

                </div>
            </div>
            
            <div id="admin-view" class="view-container bg-tma-bg hidden">
                <div class="p-4">
                    <h2 class="text-2xl font-bold mb-4">Админ Панель</h2>
                    <p class="text-gray-600 mb-6">Управление статусами пользователей.</p>
                    
                    <div class="bg-tma-card rounded-xl shadow-md p-4 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3">Управление статусом</h3>
                        <input id="target-user-id" type="text" placeholder="Введите ID пользователя" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-tma-primary mb-3">
                        
                        <div class="flex space-x-2 mb-3">
                            <button onclick="setVerificationStatus(true)" class="flex-1 p-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition text-sm">Верифицировать</button>
                            <button onclick="setVerificationStatus(false)" class="flex-1 p-3 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition text-sm">Снять верификацию</button>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="setBanStatus(true)" class="flex-1 p-3 bg-tma-red text-white font-semibold rounded-lg hover:bg-red-600 transition text-sm">Забанить</button>
                            <button onclick="setBanStatus(false)" class="flex-1 p-3 bg-tma-primary text-white font-semibold rounded-lg hover:bg-tma-primary/90 transition text-sm">Разбанить</button>
                        </div>
                    </div>
                </div>
            </div>

        </div> 
        <nav class="bg-tma-card shadow-tma-nav p-3 flex justify-around flex-shrink-0">
            <button id="home-nav-button" onclick="switchView('home')" class="nav-button flex flex-col items-center text-tma-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7m-7-7v14" />
                </svg>
                <span class="text-xs mt-1">Главная</span>
            </button>
            <button id="post-nav-button" onclick="switchView('post')" class="nav-button flex flex-col items-center text-gray-500 hover:text-tma-primary transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-xs mt-1">Пост</span>
            </button>
            <button id="profile-nav-button" onclick="switchView('profile')" class="nav-button flex flex-col items-center text-gray-500 hover:text-tma-primary transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span class="text-xs mt-1">Профиль</span>
            </button>
            <button id="admin-nav-button" onclick="switchView('admin')" class="nav-button flex flex-col items-center text-gray-500 hover:text-tma-red transition hidden">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35-.375.375-.544.896-.544 1.458v.488a.933.933 0 01-1.077.936c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35.375-.375.544-.896.544-1.458v-.488a.933.933 0 011.077-.936z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span class="text-xs mt-1">Админ</span>
            </button>
        </nav>
        </div>


    <div id="comments-view">
        <div class="bg-tma-card shadow-sm p-4 flex items-center justify-between flex-shrink-0">
            <button onclick="closeCommentsView()" class="text-tma-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h2 class="text-lg font-bold text-gray-800 flex-grow text-center">Комментарии (<span id="total-comment-count">0</span>)</h2>
            <div class="w-6"></div> </div>

        <div id="comment-list" class="flex-grow space-y-3">
            </div>
        
        <div class="bg-tma-card p-3 shadow-tma-nav flex-shrink-0">
            <form id="comment-form" onsubmit="event.preventDefault(); addComment()" class="flex space-x-2">
                <input id="comment-input" type="text" placeholder="Ваш комментарий..." class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-tma-primary">
                <button type="submit" class="bg-tma-primary text-white p-3 rounded-full w-10 h-10 flex items-center justify-center hover:bg-tma-primary/90 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </form>
        </div>
    </div>
    <script>
        // Предполагается, что функции switchView, updateHeader, navigateBack, showMessage
        // были определены в вашем файле или будут определены ниже. 
        
        // --- БЛОК ДЛЯ НАСТРОЙКИ SUPABASE (ОБЯЗАТЕЛЬНО ЗАМЕНИТЕ КЛЮЧИ) ---
        if (typeof window.__app_id === 'undefined') {
            console.warn("Using mock Supabase configuration for local development. Full functionality requires real keys.");
            
            // ВАШ РЕАЛЬНЫЙ ID приложения
            window.__app_id = 'default-tma-id'; 
            
            // ⚠️ ЗАМЕНИТЕ ЭТИ ЗНАЧЕНИЯ НА РЕАЛЬНЫЕ ИЗ ВАШЕГО ПРОЕКТА SUPABASE
            window.__supabase_url = 'https://qpdyhdvrkampgigddizx.supabase.co';
            window.__supabase_anon_key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwZHloZHZya2FtcGdpZ2RkaXp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDA4ODcsImV4cCI6MjA3NTQxNjg4N30.eBKi2hQ6pe-CN1_pqigrOwvWt6PAqeSJ0X7RdSIweS8';
            
            window.__initial_user_id = 'mock-user-' + Math.random().toString(36).substring(2, 8); 
        }
        // --- КОНЕЦ БЛОКА НАСТРОЙКИ ---
        
        // Global State and Constants
        const MOCK_VIDEO_ID = 'TMA_Vertical_001';
        const ADMIN_USER_ID = '8098423493'; 
        const GENERIC_USERNAME = 'Пользователь '; 

        let appState = {
            userId: typeof window.__initial_user_id !== 'undefined' ? window.__initial_user_id : 'fallback-user-id',
            appId: typeof window.__app_id !== 'undefined' ? window.__app_id : 'fallback-app-id',
            username: GENERIC_USERNAME,
            isVerified: false,
            isBanned: false,
            status: 'loading', 
            isSupabaseReady: false, 
            hasVideoDataLoaded: false, 
            hasLikesLoaded: false, 
            hasCommentsLoaded: false, 
            currentViewId: 'home',
            video: {
                id: MOCK_VIDEO_ID,
                publishDate: '24 сентября 2025 г.', // Дата публикации видео
                isLiked: false,
                likeCount: 0,
                comments: []
            },
            viewMap: { 'home': 0, 'post': 1, 'profile': 2, 'admin': 3 },
            viewTitles: { 'home': 'Главная', 'post': 'Публикация', 'profile': 'Профиль', 'admin': 'Админ' }
        };

        // Supabase Client Reference
        let sb;
        let realtimeChannel;
        
        // Объект для хранения ссылок на DOM-элементы
        let elements = {}; 
        
        const viewOrder = ['home', 'post', 'profile', 'admin'];
        
        // -----------------------------------------------------------
        // 3. COMMON UTILITY FUNCTIONS (Вспомогательные функции)
        // -----------------------------------------------------------
        
        // ⚠️ ИСПРАВЛЕННАЯ ФУНКЦИЯ: Collect DOM Elements
        function collectDOMElements() {
            // Nav/Global elements
            elements.mainAppContainer = document.getElementById('main-app-container');
            elements.headerTitle = document.getElementById('header-title');
            elements.headerBackButton = document.getElementById('header-back-button');
            elements.splashScreen = document.getElementById('splash-screen');
            elements.registrationView = document.getElementById('registration-view');
            elements.errorMessage = document.getElementById('error-message');
            elements.messageContainer = document.getElementById('message-container');
            elements.messageText = document.getElementById('message-text');
            
            // Registration elements
            elements.usernameInput = document.getElementById('username-input');

            // View containers
            elements.viewContainers = {
                'home': document.getElementById('home-view'),
                'post': document.getElementById('post-view'),
                'profile': document.getElementById('profile-view'),
                'admin': document.getElementById('admin-view'),
            };
            
            // Video feed elements
            elements.likeWidget = document.getElementById('like-widget');
            elements.likeCount = document.getElementById('like-count');
            elements.videoIdDisplay = document.getElementById('video-id-display');
            elements.videoLoadingOverlay = document.getElementById('video-loading-overlay');
            elements.videoDate = document.getElementById('video-date'); // ✅ Добавленный элемент

            // Comment view elements
            elements.totalCommentCount = document.getElementById('total-comment-count');
            elements.commentCount = document.getElementById('comment-count');
            elements.commentInput = document.getElementById('comment-input');
            elements.commentList = document.getElementById('comment-list');
            elements.commentsView = document.getElementById('comments-view');
            
            // Profile elements
            elements.profileUsername = document.getElementById('profile-username');
            elements.profileUserId = document.getElementById('profile-user-id');
            elements.verificationStatus = document.getElementById('verification-status');
            elements.banStatus = document.getElementById('ban-status');

            // Admin elements
            elements.adminNavButton = document.getElementById('admin-nav-button');
            elements.targetUserId = document.getElementById('target-user-id');
            elements.adminUserIdDisplay = document.getElementById('admin-user-id-display');
        }

        function switchView(viewId, pushHistory = true) {
            if (!viewOrder.includes(viewId)) return;

            const index = appState.viewMap[viewId];
            elements.mainAppContainer.style.transform = `translateX(-${index * 25}%)`;
            appState.currentViewId = viewId;

            updateHeader(viewId);
            updateNavigation(viewId);

            if (pushHistory) {
                // Remove comment history state if we switch views
                if (history.state && history.state.viewId === 'comments') {
                    history.go(-1);
                }
                history.pushState({ viewId: viewId }, '', `#${viewId}`);
            }
        }
        
        function updateHeader(viewId) {
            elements.headerTitle.textContent = appState.viewTitles[viewId] || 'Платформа';
            // Back button logic: Hide back button unless we are in comments view
            elements.headerBackButton.classList.add('hidden'); 
        }

        function updateNavigation(viewId) {
            document.querySelectorAll('.nav-button').forEach(btn => {
                const targetView = btn.id.replace('-nav-button', '');
                if (targetView === viewId) {
                    btn.classList.add('text-tma-primary');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.remove('text-tma-primary');
                    btn.classList.add('text-gray-500');
                }
            });
        }
        
        function navigateBack() {
             // In this simple app, we just simulate back using browser history
             history.back();
        }

        let messageTimeout;
        function showMessage(text, colorClass = 'bg-tma-primary') {
            clearTimeout(messageTimeout);
            
            elements.messageText.textContent = text;
            elements.messageContainer.className = `rounded-lg text-white p-3 shadow-lg ${colorClass}`;
            elements.messageContainer.style.opacity = '1';
            
            messageTimeout = setTimeout(() => {
                elements.messageContainer.style.opacity = '0';
            }, 3000);
        }

        // -----------------------------------------------------------
        // 4. SUPABASE FLOW CONTROL AND AUTH
        // -----------------------------------------------------------

        function checkVideoDataReady() {
            if (!appState.hasVideoDataLoaded && appState.hasLikesLoaded && appState.hasCommentsLoaded) {
                 elements.videoLoadingOverlay.classList.add('hidden');
                 appState.hasVideoDataLoaded = true;
            }
        }

        function hideSplashAndShowRegistration() {
            elements.splashScreen.classList.add('hidden');
            elements.registrationView.classList.remove('hidden');
            updateHeader('Регистрация');
        }

        function hideSplashAndShowMainApp() {
            elements.splashScreen.classList.add('hidden');
            elements.registrationView.classList.add('hidden');
            elements.mainAppContainer.classList.remove('hidden');
            // Set initial state without pushing history twice
            switchView('home', false); 
            updateProfileUI(); 
            updateAdminView();
        }

        function startLimitedMode() {
            appState.status = 'limited';
            appState.isSupabaseReady = false;
            
            elements.errorMessage.classList.remove('hidden');
            elements.splashScreen.classList.add('hidden');
            elements.mainAppContainer.classList.remove('hidden');
            switchView('home', false);
            updateProfileUI();
            updateAdminView();
            
            elements.videoLoadingOverlay.classList.add('hidden'); 
            appState.hasVideoDataLoaded = true;
            showMessage('Приложение работает в ограниченном режиме (нет доступа к Supabase).', 'bg-red-500');

            // Disable interactive elements that require DB
            document.getElementById('comment-form').onsubmit = (e) => { 
                e.preventDefault();
                showMessage('Функция недоступна в ограниченном режиме.', 'tma-red'); 
                return false; 
            };
            document.getElementById('like-widget').onclick = () => { showMessage('Функция недоступна в ограниченном режиме.', 'tma-red'); };
        }


        /**
         * Initializes Supabase client and checks user registration status.
         */
        async function initSupabase() {
            if (typeof window.supabase === 'undefined' || typeof window.__supabase_url === 'undefined' || typeof window.__supabase_anon_key === 'undefined') {
                console.error("Supabase configuration missing. Starting limited mode.");
                startLimitedMode();
                return;
            }
            
            if (window.__supabase_anon_key === 'ВАШ_SUPABASE_ANON_KEY') {
                console.warn("Detected mock Supabase configuration. Starting in Limited Mode immediately.");
                startLimitedMode();
                return;
            }

            try {
                sb = supabase.createClient(window.__supabase_url, window.__supabase_anon_key);
                
                // ❗ КРИТИЧЕСКИ ВАЖНО: Устанавливаем App ID для RLS (Row Level Security)
                await sb.rpc('set_app_id', { id: appState.appId }); 

                appState.isSupabaseReady = true;

                await checkRegistrationStatus();

            } catch (error) {
                console.error("Supabase Initialization Failed:", error);
                startLimitedMode();
            }
        }

        async function checkRegistrationStatus() {
            if (!appState.isSupabaseReady) return;

            try {
                const { data, error } = await sb
                    .from('users')
                    .select('username, is_verified, is_banned')
                    .eq('id', appState.userId)
                    .eq('app_id', appState.appId)
                    .single(); 

                if (error && error.code !== 'PGRST116') { 
                    throw error;
                }

                if (data && data.username && data.username !== GENERIC_USERNAME) {
                    appState.username = data.username;
                    appState.isVerified = data.is_verified || false;
                    appState.isBanned = data.is_banned || false;
                    
                    appState.status = 'ready';
                    setupRealtimeListeners();
                    hideSplashAndShowMainApp();
                } else {
                    appState.status = 'registering';
                    hideSplashAndShowRegistration();
                }
            } catch (e) {
                console.error("Error reading registration status:", e);
                appState.status = 'registering';
                hideSplashAndShowRegistration();
            }
        }
        
        async function registerUsername() {
            if (!appState.isSupabaseReady) {
                showMessage('Регистрация недоступна в ограниченном режиме.', 'tma-red');
                return;
            }

            const newUsername = elements.usernameInput.value.trim();
            if (newUsername.length < 3) {
                showMessage('Юзернейм должен быть не менее 3 символов.', 'tma-red');
                return;
            }

            try {
                const { error } = await sb
                    .from('users')
                    .upsert({
                        id: appState.userId,
                        app_id: appState.appId,
                        username: newUsername,
                        last_active: new Date().toISOString(),
                        is_verified: false,
                        is_banned: false,
                    });

                if (error) throw error;

                appState.username = newUsername;
                appState.status = 'ready';
                showMessage(`Добро пожаловать, ${newUsername}!`, 'bg-green-500');

                setupRealtimeListeners();
                hideSplashAndShowMainApp();
                
            } catch (error) {
                console.error("Registration failed:", error);
                showMessage('Ошибка при сохранении юзернейма.', 'tma-red');
            }
        }


        function setupUserAccountListener() {
            if (!appState.isSupabaseReady) return;

            sb.channel('user_status_channel')
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'users', 
                    filter: `app_id=eq.${appState.appId}&id=eq.${appState.userId}` 
                }, (payload) => {
                    const userData = payload.new;
                    appState.isVerified = userData.is_verified || false;
                    appState.isBanned = userData.is_banned || false;
                    
                    if (userData.username) {
                         appState.username = userData.username;
                    }
                    
                    updateProfileUI();

                    if (appState.isBanned) {
                        showMessage('Ваш аккаунт был забанен.', 'tma-red');
                        if (appState.currentViewId !== 'profile') {
                             switchView('profile');
                        }
                    }
                })
                .subscribe();
        }
        
        function setupRealtimeListeners() {
            if (!appState.isSupabaseReady) return;

            setupUserAccountListener();
            
            realtimeChannel = sb.channel('video_feed_realtime')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'likes',
                    filter: `app_id=eq.${appState.appId}&video_id=eq.${MOCK_VIDEO_ID}`
                }, fetchLikesAndComments)
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'comments', 
                    filter: `app_id=eq.${appState.appId}&video_id=eq.${MOCK_VIDEO_ID}`
                }, fetchLikesAndComments)
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        fetchLikesAndComments(); 
                    }
                });
            
            elements.videoIdDisplay.textContent = MOCK_VIDEO_ID;
        }
        
        async function fetchLikesAndComments() {
            if (!appState.isSupabaseReady) return;

            // Fetch Likes Count
            const { count: likeCount, error: likeError } = await sb
                .from('likes')
                .select('*', { count: 'exact', head: true })
                .eq('app_id', appState.appId)
                .eq('video_id', MOCK_VIDEO_ID);
                
            if (likeError) console.error("Error fetching likes count:", likeError);
            appState.video.likeCount = likeCount || 0;

            // Check if current user liked
            const { data: likedData, error: likedError } = await sb
                .from('likes')
                .select('user_id')
                .eq('app_id', appState.appId)
                .eq('video_id', MOCK_VIDEO_ID)
                .eq('user_id', appState.userId);
            
            if (likedError) console.error("Error checking user like:", likedError);
            appState.video.isLiked = likedData && likedData.length > 0;
            
            appState.hasLikesLoaded = true;


            // Fetch Comments
            const { data: commentsData, error: commentsError } = await sb
                .from('comments')
                .select('*')
                .eq('app_id', appState.appId)
                .eq('video_id', MOCK_VIDEO_ID)
                .order('created_at', { ascending: false });
            
            if (commentsError) console.error("Error fetching comments:", commentsError);

            if (commentsData) {
                appState.video.comments = commentsData.map(c => ({
                    id: c.id,
                    userId: c.user_id,
                    username: c.username,
                    text: c.text,
                    timestamp: new Date(c.created_at),
                    timestampFormatted: new Date(c.created_at).toLocaleString('ru-RU', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' })
                }));
            } else {
                 appState.video.comments = [];
            }
            
            appState.hasCommentsLoaded = true;
            
            updateVideoUI();
            updateCommentsListUI();
            checkVideoDataReady();
        }
        
        // -----------------------------------------------------------
        // 5. INTERACTION LOGIC (SUPABASE)
        // -----------------------------------------------------------

        function updateVideoUI() {
            elements.likeCount.textContent = appState.video.likeCount;
            elements.likeWidget.classList.toggle('liked', appState.video.isLiked);
            elements.videoDate.textContent = appState.video.publishDate; // ✅ Обновление даты
        }

        async function toggleLike() {
            if (!appState.isSupabaseReady) {
                showMessage('Функция недоступна в ограниченном режиме.', 'tma-red');
                return;
            }
            if (appState.isBanned) {
                showMessage('Вы не можете ставить лайки, так как ваш аккаунт забанен.', 'tma-red');
                return;
            }

            try {
                if (appState.video.isLiked) {
                    const { error } = await sb
                        .from('likes')
                        .delete()
                        .eq('user_id', appState.userId)
                        .eq('video_id', MOCK_VIDEO_ID)
                        .eq('app_id', appState.appId);

                    if (error) throw error;
                } else {
                    const { error } = await sb
                        .from('likes')
                        .insert({ 
                            user_id: appState.userId, 
                            video_id: MOCK_VIDEO_ID, 
                            app_id: appState.appId,
                            created_at: new Date().toISOString()
                        });
                        
                    if (error) throw error;
                }
            } catch (e) {
                console.error("Error toggling like:", e);
                showMessage('Ошибка при обновлении лайка.', 'tma-red');
            }
        }
        
        async function addComment() {
            if (!appState.isSupabaseReady) {
                showMessage('Функция недоступна в ограниченном режиме.', 'tma-red');
                return;
            }
            if (appState.isBanned) {
                showMessage('Вы не можете комментировать, так как ваш аккаунт забанен.', 'tma-red');
                return;
            }

            const commentText = elements.commentInput.value.trim();
            if (commentText.length === 0) return;

            try {
                const { error } = await sb
                    .from('comments')
                    .insert({
                        user_id: appState.userId,
                        video_id: MOCK_VIDEO_ID,
                        app_id: appState.appId,
                        username: appState.username,
                        text: commentText,
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                elements.commentInput.value = ''; 
                showMessage('Комментарий добавлен!', 'bg-green-500');
            } catch (e) {
                console.error("Error adding comment:", e);
                showMessage('Ошибка при добавлении комментария.', 'tma-red');
            }
        }
        
        function updateCommentsListUI() {
            elements.totalCommentCount.textContent = appState.video.comments.length;
            elements.commentCount.textContent = appState.video.comments.length;
            
            if (appState.video.comments.length === 0) {
                elements.commentList.innerHTML = '<p class="text-center text-gray-500 mt-8">Будьте первым, кто прокомментирует!</p>';
                return;
            }

            elements.commentList.innerHTML = appState.video.comments.map(comment => `
                <div class="flex space-x-3 bg-tma-card p-3 rounded-xl shadow-sm">
                    <img class="w-8 h-8 rounded-full" src="https://placehold.co/32x32/179cde/ffffff?text=${comment.username.substring(0,1).toUpperCase()}" alt="Avatar">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <p class="text-sm font-semibold text-gray-800">${comment.username} ${comment.userId === appState.userId ? '<span class="text-tma-primary text-xs font-normal">(Вы)</span>' : ''}</p>
                            <span class="text-xs text-gray-400">${comment.timestampFormatted}</span>
                        </div>
                        <p class="text-gray-700 mt-1 text-sm">${comment.text}</p>
                        ${comment.userId === appState.userId && appState.isSupabaseReady ? 
                            `<button class="text-tma-red text-xs mt-1" onclick="deleteComment('${comment.id}')">Удалить</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            if (elements.commentsView.classList.contains('show-comments')) {
                elements.commentList.scrollTop = elements.commentList.scrollHeight;
            }
        }

        async function deleteComment(commentId) {
            if (!appState.isSupabaseReady) {
                showMessage('Функция недоступна в ограниченном режиме.', 'tma-red');
                return;
            }
            
            try {
                const { error } = await sb
                    .from('comments')
                    .delete()
                    .eq('id', commentId)
                    .eq('user_id', appState.userId); 

                if (error) throw error;
                showMessage('Комментарий удален.', 'bg-green-500');
            } catch (e) {
                console.error("Error deleting comment:", e);
                showMessage('Ошибка при удалении комментария.', 'tma-red');
            }
        }

        function openCommentsView() {
            elements.commentsView.classList.add('show-comments');
            history.pushState({ viewId: 'comments' }, '', '#comments');
            elements.commentList.scrollTop = elements.commentList.scrollHeight;
        }

        function closeCommentsView() {
            elements.commentsView.classList.remove('show-comments');
            if (history.state && history.state.viewId === 'comments') {
                history.back();
            }
        }

        function updateProfileUI() {
            elements.profileUsername.textContent = appState.username;
            elements.profileUserId.textContent = `ID: ${appState.userId}`;
            elements.adminUserIdDisplay.textContent = appState.userId;
            
            if (appState.isVerified) {
                elements.verificationStatus.textContent = '✅ Верифицирован';
                elements.verificationStatus.classList.remove('text-gray-500');
                elements.verificationStatus.classList.add('text-tma-primary');
            } else {
                elements.verificationStatus.textContent = '⚪ Не верифицирован';
                elements.verificationStatus.classList.remove('text-tma-primary');
                elements.verificationStatus.classList.add('text-gray-500');
            }
            
            elements.banStatus.classList.toggle('hidden', !appState.isBanned);
        }

        function updateAdminView() {
            const isAdmin = appState.userId === ADMIN_USER_ID && appState.isSupabaseReady; 
            elements.adminNavButton.classList.toggle('hidden', !isAdmin);
            
            if (isAdmin) {
                document.getElementById('admin-view').style.width = 'calc(100% / 4)'; 
                document.getElementById('admin-view').classList.remove('hidden');
                appState.viewTitles['admin'] = 'Админ';
            } else {
                document.getElementById('admin-view').classList.add('hidden');
                delete appState.viewTitles['admin'];
            }
        }
        
        async function updateAdminStatus(targetId, field, status, successMessage) {
            if (!appState.isSupabaseReady || appState.userId !== ADMIN_USER_ID || !targetId) {
                showMessage(appState.userId !== ADMIN_USER_ID ? 'Отказано в доступе.' : 'Введите ID пользователя.', 'tma-red');
                return false;
            }
            
            try {
                const { error } = await sb
                    .from('users')
                    .update({ [field]: status })
                    .eq('id', targetId)
                    .eq('app_id', appState.appId);

                if (error) throw error;
                showMessage(`Пользователь ${targetId.substring(0, 8)}...: ${successMessage}`, 'bg-green-500');
                return true;
            } catch (e) {
                console.error(`Error setting ${field} status:`, e);
                showMessage('Ошибка при обновлении статуса.', 'tma-red');
                return false;
            }
        }

        function setVerificationStatus(status) {
             const targetId = elements.targetUserId.value.trim();
             updateAdminStatus(targetId, 'is_verified', status, status ? 'Верифицирован' : 'Снята верификация');
        }
        
        function setBanStatus(status) {
            const targetId = elements.targetUserId.value.trim();
            updateAdminStatus(targetId, 'is_banned', status, status ? 'Забанен' : 'Разбанен');
        }
        
        function publishVideo() {
            const caption = document.getElementById('caption-input').value.trim();
            if (caption.length < 5) {
                 showMessage('Описание должно быть длиннее 5 символов.', 'tma-red');
                 return;
            }

            showMessage(`Видео с описанием: "${caption.substring(0, 20)}..." опубликовано (модель).`, 'bg-tma-primary');
            document.getElementById('caption-input').value = '';
            switchView('home');
        }

        // Handle browser back/forward buttons 
        window.onpopstate = (event) => {
            const targetViewId = event.state && event.state.viewId ? event.state.viewId : 'home';
            
            // Handle comments view close
            if (targetViewId !== 'comments' && elements.commentsView.classList.contains('show-comments')) {
                elements.commentsView.classList.remove('show-comments');
            }
            
            // Handle comments view open
            if (targetViewId === 'comments' && !elements.commentsView.classList.contains('show-comments')) {
                elements.commentsView.classList.add('show-comments');
            }
            
            if (targetViewId !== 'comments') {
                 if (appState.currentViewId !== targetViewId) {
                    switchView(targetViewId, false);
                 }
            }
        };

        
        // --- APPLICATION ENTRY POINT ---
        window.onload = function () {
            // 1. Collect elements after the DOM is fully loaded
            collectDOMElements(); // ⬅️ Теперь функция определена!
            
            // 2. Start Supabase initialization and auth check
            initSupabase();
            
            // Make functions available globally for inline HTML event handlers
            window.switchView = switchView;
            window.registerUsername = registerUsername;
            window.toggleLike = toggleLike;
            window.openCommentsView = openCommentsView;
            window.closeCommentsView = closeCommentsView;
            window.addComment = addComment;
            window.deleteComment = deleteComment;
            window.navigateBack = navigateBack;
            window.setVerificationStatus = setVerificationStatus;
            window.setBanStatus = setBanStatus;
            window.publishVideo = publishVideo;
            window.showMessage = showMessage;
        };
    </script>
</body>
</html>
