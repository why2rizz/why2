<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Feed Mini App</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Tailwind CSS -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tma-primary': '#007AFF',
                        'tma-bg': '#f5f5f5',
                        'tma-card': '#ffffff',
                        'tma-red': '#FF3B30',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'tma-nav': '0 -4px 6px -1px rgba(0, 0, 0, 0.05), 0 -2px 4px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        #app-container {
            max-width: 600px;
            height: 100vh;
            margin: 0 auto;
            position: relative;
            background-color: #000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ª–∞–π–¥–∏–Ω–≥–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫ */
        #content-slider {
            display: flex;
            width: 400%; /* 3 –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ + –ê–¥–º–∏–Ω */
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: absolute;
            top: 0;
            left: 0;
            padding-bottom: 60px; /* –£—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        }

        .main-view {
            width: calc(100% / 4);
            flex-shrink: 0;
            height: 100%;
            overflow-y: auto;
            padding-top: 56px;
        }

        /* –ü–µ—Ä–µ—Ö–æ–¥ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–Ω–∞–µ–∑–∂–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö) */
        #comments-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: theme('colors.tma-bg');
            z-index: 20;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            flex-direction: column;
        }

        .comment-list-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 70px;
        }

        .show-comments {
            transform: translateX(0) !important;
        }

        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –õ–∞–π–∫ */
        .like-icon {
            transition: color 0.2s, transform 0.1s;
        }

        .liked .like-icon {
            color: theme('colors.tma-red');
            transform: scale(1.1);
            animation: pulse 0.3s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1.1); }
        }

        /* Loading Spinner Animation */
        .spinner {
            border-top-color: theme('colors.tma-primary');
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="shadow-2xl">
        
        <!-- --- 1. –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò (SPLASH SCREEN) --- -->
        <div id="splash-screen" class="absolute inset-0 bg-tma-bg z-50 flex flex-col items-center justify-center transition-opacity duration-500">
            <div class="spinner border-4 border-gray-200 border-solid rounded-full h-12 w-12 mb-4"></div>
            <p class="text-gray-600 font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>

        <!-- --- 2. –≠–ö–†–ê–ù –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –Æ–ó–ï–†–ù–ï–ô–ú–ê --- -->
        <div id="registration-view" class="absolute inset-0 bg-tma-bg z-40 flex flex-col items-center justify-center p-6 hidden">
            <div class="max-w-xs w-full bg-tma-card rounded-xl shadow-xl p-6 text-center">
                <h2 class="text-2xl font-bold mb-3">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                <p class="text-gray-600 mb-6">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —é–∑–µ—Ä–Ω–µ–π–º –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ø—Ä–æ—Ñ–∏–ª—è.</p>
                <form onsubmit="event.preventDefault(); registerUsername()">
                    <input type="text" id="username-input" class="w-full p-3 border border-gray-300 rounded-lg text-lg text-center focus:outline-none focus:ring-2 focus:ring-tma-primary transition duration-150" placeholder="–í–∞—à —é–∑–µ—Ä–Ω–µ–π–º" required minlength="3">
                    <button type="submit" class="w-full mt-5 py-3 px-4 rounded-full text-white font-medium bg-tma-primary hover:bg-tma-primary/90 transition duration-150">
                        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                    </button>
                </form>
            </div>
        </div>

        <!-- --- 3. –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (MAIN APP) --- -->
        <div id="main-app-container" class="hidden h-full w-full">

            <!-- –í–µ—Ä—Ö–Ω–∏–π —Ö–µ–¥–µ—Ä —Å –∫–Ω–æ–ø–∫–æ–π –ù–∞–∑–∞–¥/–ü–æ–∏—Å–∫ -->
            <header id="app-header" class="fixed top-0 w-full max-w-md bg-tma-card p-3 border-b border-gray-200 z-30 flex justify-between items-center transition-opacity duration-300">
                <button id="back-button" class="text-tma-primary font-medium flex items-center hidden" onclick="navigateBack()">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    –ù–∞–∑–∞–¥
                </button>
                <h1 id="header-title" class="text-lg font-bold mx-auto"><!-- Title controlled by JS --></h1>
                <button id="search-button" class="text-tma-primary p-1 rounded-full hover:bg-gray-100" onclick="showMessage('–§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.', 'tma-primary')">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>
            </header>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ª–∞–π–¥–∏–Ω–≥–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫ -->
            <div id="content-slider">
                
                <!-- 1. –í–∫–ª–∞–¥–∫–∞: –ì–õ–ê–í–ù–ê–Ø (–õ–µ–Ω—Ç–∞ –í–∏–¥–µ–æ) -->
                <div id="home-view" class="main-view bg-black">
                    <!-- –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –í–∏–¥–µ–æ -->
                    <div class="h-full w-full relative">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –æ–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
                        <div id="video-loading-overlay" class="absolute inset-0 bg-gray-900/90 z-10 flex flex-col items-center justify-center text-white text-center p-4">
                            <div class="spinner border-4 border-t-tma-primary border-solid rounded-full h-8 w-8 mb-4"></div>
                            <p class="text-xl font-bold">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ...</p>
                        </div>
                        
                        <div class="absolute inset-0 flex flex-col items-center justify-center text-white text-center p-4">
                            <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            <p class="font-light">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ. ID: <span id="video-id-display" class="font-mono">...</span></p>
                        </div>

                        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –õ–∞–π–∫–æ–≤/–ö–æ–º–º–µ–Ω—Ç–æ–≤ -->
                        <div class="absolute bottom-20 right-4 flex flex-col items-center space-y-6 text-white z-20">
                            
                            <!-- –õ–∞–π–∫–∏ -->
                            <div id="like-widget" class="flex flex-col items-center cursor-pointer select-none" onclick="toggleLike()">
                                <svg class="like-icon w-8 h-8" id="like-icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                <span id="like-count" class="text-sm font-semibold mt-1">...</span>
                            </div>
                            
                            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
                            <div class="flex flex-col items-center cursor-pointer select-none" onclick="openCommentsView()">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                                <span id="comment-count" class="text-sm font-semibold mt-1">...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. –í–∫–ª–∞–¥–∫–∞: –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø (–§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏) -->
                <div id="post-view" class="main-view bg-tma-bg p-4">
                    <div class="max-w-sm mx-auto bg-tma-card rounded-xl shadow-lg p-6 mt-4">
                        <h2 class="text-2xl font-semibold text-center mb-6">–°–æ–∑–¥–∞—Ç—å –í–∏–¥–µ–æ</h2>
                        
                        <form onsubmit="event.preventDefault(); publishVideo()" class="mt-6">
                            <div class="mb-4">
                                <label for="video-upload" class="block text-sm font-medium text-gray-700 mb-2">–ó–∞–≥—Ä—É–∑–∏—Ç—å –§–∞–π–ª (–ó–∞–≥–ª—É—à–∫–∞)</label>
                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                    <p class="text-xs text-gray-500">–í–∏–¥–µ–æ –Ω–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ, —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ.</p>
                                </div>
                            </div>

                            <div class="mb-6">
                                <label for="caption-input" class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea id="caption-input" rows="3" class="shadow-sm focus:ring-tma-primary focus:border-tma-primary mt-1 block w-full sm:text-sm border border-gray-300 rounded-md p-2" placeholder="–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..." required></textarea>
                            </div>
                            
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-full shadow-sm text-sm font-medium text-white bg-tma-primary hover:bg-tma-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-tma-primary transition duration-150">
                                –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                            </button>
                        </form>
                    </div>
                </div>

                <!-- 3. –í–∫–ª–∞–¥–∫–∞: –ü–†–û–§–ò–õ–¨ -->
                <div id="profile-view" class="main-view bg-tma-bg p-4">
                    <div class="max-w-sm mx-auto bg-tma-card rounded-xl shadow-lg p-6 mt-4 text-center">
                        <img class="w-24 h-24 rounded-full mx-auto mb-4 object-cover" src="https://placehold.co/96x96/007AFF/ffffff?text=U" alt="Profile Picture">
                        <h2 class="text-2xl font-bold" id="profile-username">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                        <p class="text-gray-500 mb-4 text-sm break-all" id="profile-userid">ID: ...</p>
                        <p class="text-sm font-semibold mb-4" id="verification-status"></p>
                        <p class="text-sm font-semibold text-tma-red mb-4 hidden" id="ban-status">‚ö†Ô∏è –ê–ö–ö–ê–£–ù–¢ –ó–ê–ë–ê–ù–ï–ù</p>

                        <button class="bg-gray-200 text-gray-800 font-medium py-2 px-6 rounded-full hover:bg-gray-300 transition duration-150">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>

                        <div class="mt-8 pt-4 border-t border-gray-200">
                            <h3 class="text-xl font-semibold mb-4 text-left">–ú–æ–∏ –í–∏–¥–µ–æ</h3>
                            <div class="grid grid-cols-3 gap-1">
                                <div class="aspect-h-1 aspect-w-1 bg-gray-300 rounded-md overflow-hidden flex items-center justify-center text-xs text-gray-600">–í–∏–¥–µ–æ 1</div>
                                <div class="aspect-h-1 aspect-w-1 bg-gray-400 rounded-md overflow-hidden flex items-center justify-center text-xs text-gray-600">–í–∏–¥–µ–æ 2</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. –í–∫–ª–∞–¥–∫–∞: –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ (Admin Panel) -->
                <div id="admin-view" class="main-view bg-tma-bg p-4 hidden">
                    <div class="max-w-sm mx-auto bg-tma-card rounded-xl shadow-lg p-6 mt-4">
                        <h2 class="text-2xl font-semibold text-center mb-6 text-tma-red">üîê –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨</h2>
                        <p class="text-sm text-gray-600 mb-4">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. (–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–π User ID: <span class="font-mono text-tma-primary" id="admin-user-id-display">...</span>).</p>

                        <div class="mb-4">
                            <label for="target-user-id" class="block text-sm font-medium text-gray-700 mb-2">ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                            <input type="text" id="target-user-id" class="w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è">
                        </div>

                        <div class="space-y-3">
                            <button onclick="setVerificationStatus(true)" class="w-full py-2 px-4 rounded-full text-white font-medium bg-green-500 hover:bg-green-600 transition duration-150">
                                ‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ê–∫–∫–∞—É–Ω—Ç
                            </button>
                            <button onclick="setVerificationStatus(false)" class="w-full py-2 px-4 rounded-full text-white font-medium bg-yellow-500 hover:bg-yellow-600 transition duration-150">
                                üîÑ –°–Ω—è—Ç—å –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é
                            </button>
                            <button onclick="setBanStatus(true)" class="w-full py-2 px-4 rounded-full text-white font-medium bg-tma-red hover:bg-red-600 transition duration-150">
                                üö´ –ó–∞–±–∞–Ω–∏—Ç—å –ê–∫–∫–∞—É–Ω—Ç
                            </button>
                            <button onclick="setBanStatus(false)" class="w-full py-2 px-4 rounded-full text-white font-medium bg-gray-500 hover:bg-gray-600 transition duration-150">
                                üîì –†–∞–∑–±–∞–Ω–∏—Ç—å –ê–∫–∫–∞—É–Ω—Ç
                            </button>
                        </div>
                    </div>
                </div>
                
            </div>

            <!-- 5. –í–∫–ª–∞–¥–∫–∞: –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò (–°–ª–∞–π–¥–∏–Ω–≥-–æ–≤–µ—Ä–ª–µ–π) -->
            <div id="comments-view" class="shadow-2xl">
                <header class="bg-tma-card p-3 border-b border-gray-200 sticky top-0 z-10 flex justify-between items-center">
                    <button class="text-tma-primary font-medium flex items-center" onclick="closeCommentsView()">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                    <h2 class="text-lg font-bold">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (<span id="total-comment-count">...</span>)</h2>
                    <div class="w-16"></div>
                </header>
                
                <div id="comment-list" class="comment-list-container p-4 space-y-4">
                    <p class="text-center text-gray-500 mt-8">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</p>
                </div>

                <div class="absolute bottom-0 w-full bg-tma-card p-3 border-t border-gray-200">
                    <form id="comment-form" onsubmit="event.preventDefault(); addComment()">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="comment-input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-tma-primary text-sm" required>
                            <button type="submit" class="bg-tma-primary text-white p-3 rounded-full hover:bg-tma-primary/90 transition duration-150">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.01 6.03l15.98 6L4.01 18l.01-4.7L13 12 4.02 10.74l-.01-4.71z"/></svg>
                            </button>
                        </div>
                    </form>
                </div>
            </div>


            <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
            <nav id="bottom-nav" class="fixed bottom-0 w-full max-w-md h-[60px] bg-tma-card shadow-tma-nav z-40 flex justify-around items-center">
                
                <button class="nav-item flex flex-col items-center justify-center p-2 text-tma-primary" data-view-id="home" onclick="switchView('home')">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                    <span class="text-xs">–ì–ª–∞–≤–Ω–∞—è</span>
                </button>
                
                <div class="flex-1"></div>

                <button class="bg-tma-primary text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg transform -translate-y-2 hover:bg-tma-primary/90 transition duration-150" data-view-id="post" onclick="switchView('post')">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>

                <div class="flex-1"></div>

                <button class="nav-item flex flex-col items-center justify-center p-2 text-gray-500" data-view-id="profile" onclick="switchView('profile')">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.38 0 2.5 1.12 2.5 2.5S13.38 10 12 10 9.5 8.88 9.5 7.5 10.62 5 12 5zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.88 6-3.88s5.97 1.89 6 3.88c-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                    <span class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span>
                </button>

                <button id="admin-nav-button" class="nav-item flex flex-col items-center justify-center p-2 text-gray-500 hidden" data-view-id="admin" onclick="switchView('admin')">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 18c-3.73-1.29-6-5.11-6-9.84V6.32l6-2.67 6 2.67v2.84c0 4.73-2.27 8.55-6 9.84zm1-11h-2V7h2v2zm0 4h-2v-2h2v2z"/></svg>
                    <span class="text-xs">–ê–¥–º–∏–Ω</span>
                </button>
            </nav>
            
            <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π (–∑–∞–º–µ–Ω–∞ alert) -->
            <div id="message-box" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white font-medium text-sm shadow-xl transition-all duration-300 opacity-0 pointer-events-none z-50"></div>

            <!-- –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ -->
            <div id="error-message" class="fixed inset-0 bg-black/80 text-white z-50 flex items-center justify-center p-4 hidden">
                <div class="bg-red-700 p-6 rounded-lg text-center rounded-xl shadow-2xl">
                    <p class="font-bold text-xl mb-3">‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!</p>
                    <p class="text-sm">–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Firebase. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ (—Ç–æ–ª—å–∫–æ UI).</p>
                    <p class="text-xs mt-3 opacity-75">–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –∑–∞–º–µ–Ω–∏—Ç–µ —Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –∫–ª—é—á–∏ –≤ –∫–æ–¥–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ Firebase.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        
        // --- –ë–õ–û–ö –î–õ–Ø –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò–¢–ï –ö–õ–Æ–ß–ò) ---
        // –ï—Å–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã (—Ç.–µ. –∑–∞–ø—É—Å–∫ –Ω–µ –≤ —Å—Ä–µ–¥–µ Canvas),
        // –º—ã —Å–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–±–æ—è.
        if (typeof window.__app_id === 'undefined') {
            console.warn("Using mock Supabase configuration for local development. Full functionality requires real keys.");
            
            // –í–ê–® –†–ï–ê–õ–¨–ù–´–ô ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö)
            window.__app_id = 'default-tma-id'; 
            
            // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –ó–ù–ê–ß–ï–ù–ò–Ø –ù–ê –†–ï–ê–õ–¨–ù–´–ï –ò–ó –í–ê–®–ï–ì–û –ü–†–û–ï–ö–¢–ê SUPABASE
            window.__supabase_url = 'https://qpdyhdvrkampgigddizx.supabase.co';
            window.__supabase_anon_key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwZHloZHZya2FtcGdpZ2RkaXp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDA4ODcsImV4cCI6MjA3NTQxNjg4N30.eBKi2hQ6pe-CN1_pqigrOwvWt6PAqeSJ0X7RdSIweS8';
            
            // –í Supabase –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º User ID, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç Telegram
            window.__initial_user_id = 'mock-user-' + Math.random().toString(36).substring(2, 8); 
        }
        // --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –ù–ê–°–¢–†–û–ô–ö–ò ---
        
        // Global State and Constants
        const MOCK_VIDEO_ID = 'TMA_Vertical_001';
        const ADMIN_USER_ID = '8098423493'; 
        const GENERIC_USERNAME = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '; 

        let appState = {
            userId: typeof window.__initial_user_id !== 'undefined' ? window.__initial_user_id : 'fallback-user-id',
            appId: typeof window.__app_id !== 'undefined' ? window.__app_id : 'fallback-app-id',
            username: GENERIC_USERNAME,
            isVerified: false,
            isBanned: false,
            // Track connection status
            status: 'loading', // current status: 'loading', 'registering', 'ready', 'limited'
            isSupabaseReady: false, // Flag to track if Supabase successfully initialized
            hasVideoDataLoaded: false, 
            hasLikesLoaded: false, 
            hasCommentsLoaded: false, 
            currentViewId: 'home',
            video: {
                id: MOCK_VIDEO_ID,
                isLiked: false,
                likeCount: 0,
                comments: []
            },
            viewMap: { 'home': 0, 'post': 1, 'profile': 2, 'admin': 3 },
            viewTitles: { 'home': '–ì–ª–∞–≤–Ω–∞—è', 'post': '–ü—É–±–ª–∏–∫–∞—Ü–∏—è', 'profile': '–ü—Ä–æ—Ñ–∏–ª—å', 'admin': '–ê–¥–º–∏–Ω' }
        };

        // Supabase Client Reference
        let sb;
        let realtimeChannel;
        
        // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        let elements = {}; 

        const viewOrder = ['home', 'post', 'profile', 'admin'];
        
        // –§—É–Ω–∫—Ü–∏–∏ view control (collectDOMElements, switchView, updateHeader, navigateBack, showMessage)
        // –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
        
        /**
         * --- SUPABASE INITIALIZATION FLOW CONTROL ---
         */
        
        function checkVideoDataReady() {
            if (!appState.hasVideoDataLoaded && appState.hasLikesLoaded && appState.hasCommentsLoaded) {
                 elements.videoLoadingOverlay.classList.add('hidden');
                 appState.hasVideoDataLoaded = true;
            }
        }

        function hideSplashAndShowRegistration() {
            elements.splashScreen.classList.add('hidden');
            elements.registrationView.classList.remove('hidden');
            updateHeader('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è');
        }

        function hideSplashAndShowMainApp() {
            elements.splashScreen.classList.add('hidden');
            elements.registrationView.classList.add('hidden');
            elements.mainAppContainer.classList.remove('hidden');
            // Set initial state without pushing history twice
            switchView('home', false); 
            updateProfileUI(); 
            updateAdminView();
        }

        /**
         * Fallback to limited mode if Supabase fails to initialize.
         */
        function startLimitedMode() {
            appState.status = 'limited';
            appState.isSupabaseReady = false;
            
            elements.errorMessage.classList.remove('hidden');
            elements.splashScreen.classList.add('hidden');
            elements.mainAppContainer.classList.remove('hidden');
            switchView('home', false);
            updateProfileUI();
            updateAdminView();
            
            elements.videoLoadingOverlay.classList.add('hidden'); 
            appState.hasVideoDataLoaded = true;
            showMessage('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ (–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Supabase).', 'bg-red-500');

            // Disable interactive elements that require DB
            document.getElementById('comment-form').onsubmit = (e) => { 
                e.preventDefault();
                showMessage('–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.', 'tma-red'); 
                return false; 
            };
            document.getElementById('like-widget').onclick = () => { showMessage('–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.', 'tma-red'); };
        }


        /**
         * --- SUPABASE CONNECTION AND AUTHENTICATION ---
         */

        /**
         * Initializes Supabase client and checks user registration status.
         */
        async function initSupabase() {
            // 1. Basic Check & Mock Key Detection
            if (typeof window.supabase === 'undefined' || typeof window.__supabase_url === 'undefined' || typeof window.__supabase_anon_key === 'undefined') {
                console.error("Supabase configuration missing. Starting limited mode.");
                startLimitedMode();
                return;
            }
            
            // –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π –∫–ª—é—á, –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Supabase, –∞ —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º.
            if (window.__supabase_anon_key === '–í–ê–®_SUPABASE_ANON_KEY') {
                console.warn("Detected mock Supabase configuration. Starting in Limited Mode immediately.");
                startLimitedMode();
                return;
            }

            // 2. Real Initialization Attempt
            try {
// –í initSupabase()
sb = supabase.createClient(window.__supabase_url, window.__supabase_anon_key);

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º App ID –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ RLS-–ø–æ–ª–∏—Ç–∏–∫–∞—Ö
await sb.rpc('set_app_id', { id: appState.appId }); 

appState.isSupabaseReady = true;

                // 3. Check if user is registered (relying on appState.userId being set from Telegram context)
                await checkRegistrationStatus();

            } catch (error) {
                console.error("Supabase Initialization Failed:", error);
                startLimitedMode();
            }
        }

        /**
         * Checks the user's profile for a saved username.
         */
        async function checkRegistrationStatus() {
            if (!appState.isSupabaseReady) return;

            try {
                // Query: SELECT username, is_verified, is_banned FROM users WHERE id = {userId} AND app_id = {appId}
                const { data, error } = await sb
                    .from('users')
                    .select('username, is_verified, is_banned')
                    .eq('id', appState.userId)
                    .eq('app_id', appState.appId)
                    .single(); // –û–∂–∏–¥–∞–µ–º –æ–¥–Ω—É –∑–∞–ø–∏—Å—å

                if (error && error.code !== 'PGRST116') { // PGRST116 is "no rows found"
                    throw error;
                }

                if (data && data.username && data.username !== GENERIC_USERNAME) {
                    // User is registered
                    appState.username = data.username;
                    appState.isVerified = data.is_verified || false;
                    appState.isBanned = data.is_banned || false;
                    
                    // Proceed to main app
                    appState.status = 'ready';
                    setupRealtimeListeners();
                    hideSplashAndShowMainApp();
                } else {
                    // User needs to register username
                    appState.status = 'registering';
                    hideSplashAndShowRegistration();
                }
            } catch (e) {
                console.error("Error reading registration status:", e);
                // Fallback to registration screen if read fails
                appState.status = 'registering';
                hideSplashAndShowRegistration();
            }
        }
        
        /**
         * Saves the username and finishes registration.
         */
        async function registerUsername() {
            if (!appState.isSupabaseReady) {
                showMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.', 'tma-red');
                return;
            }

            const newUsername = elements.usernameInput.value.trim();
            if (newUsername.length < 3) {
                showMessage('–Æ–∑–µ—Ä–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤.', 'tma-red');
                return;
            }

            try {
                const { error } = await sb
                    .from('users')
                    .upsert({
                        id: appState.userId,
                        app_id: appState.appId,
                        username: newUsername,
                        last_active: new Date().toISOString(), // Supabase uses ISO string for timestamp
                        is_verified: false,
                        is_banned: false,
                    });

                if (error) throw error;

                appState.username = newUsername;
                appState.status = 'ready';
                showMessage(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${newUsername}!`, 'bg-green-500');

                // Transition to main app
                setupRealtimeListeners();
                hideSplashAndShowMainApp();
                
            } catch (error) {
                console.error("Registration failed:", error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —é–∑–µ—Ä–Ω–µ–π–º–∞.', 'tma-red');
            }
        }


        /**
         * Updates user profile data and listens for status changes (Ban/Verification).
         */
        function setupUserAccountListener() {
            if (!appState.isSupabaseReady) return;

            // Supabase Realtime requires a separate listener for user's profile changes
            // Filter: table = 'users', type = 'UPDATE', app_id = {appId}, id = {userId}
            sb.channel('user_status_channel')
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'users', 
                    filter: `app_id=eq.${appState.appId}&id=eq.${appState.userId}` 
                }, (payload) => {
                    const userData = payload.new;
                    appState.isVerified = userData.is_verified || false;
                    appState.isBanned = userData.is_banned || false;
                    
                    if (userData.username) {
                         appState.username = userData.username;
                    }
                    
                    updateProfileUI();

                    if (appState.isBanned) {
                        showMessage('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª –∑–∞–±–∞–Ω–µ–Ω.', 'tma-red');
                        if (appState.currentViewId !== 'profile') {
                             switchView('profile');
                        }
                    }
                })
                .subscribe();
        }
        
        /**
         * Sets up real-time listeners for comments and likes.
         */
        function setupRealtimeListeners() {
            if (!appState.isSupabaseReady) return;

            // 1. User Profile Listener
            setupUserAccountListener();
            
            // 2. Realtime Listener for Likes and Comments (using a single channel for efficiency)
            realtimeChannel = sb.channel('video_feed_realtime')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'likes',
                    filter: `app_id=eq.${appState.appId}&video_id=eq.${MOCK_VIDEO_ID}`
                }, fetchLikesAndComments) // Fetch both whenever a like changes
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'comments', 
                    filter: `app_id=eq.${appState.appId}&video_id=eq.${MOCK_VIDEO_ID}`
                }, fetchLikesAndComments) // Fetch both whenever a comment changes
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        // Initial fetch after subscription is ready
                        fetchLikesAndComments(); 
                    }
                });
            
            // Set video ID display
            elements.videoIdDisplay.textContent = MOCK_VIDEO_ID;
        }
        
        /**
         * Fetches current state of Likes and Comments (called on subscription and on change).
         */
        async function fetchLikesAndComments() {
            if (!appState.isSupabaseReady) return;

            // Fetch Likes Count
            const { count: likeCount, error: likeError } = await sb
                .from('likes')
                .select('*', { count: 'exact', head: true })
                .eq('app_id', appState.appId)
                .eq('video_id', MOCK_VIDEO_ID);
                
            if (likeError) console.error("Error fetching likes count:", likeError);
            appState.video.likeCount = likeCount || 0;

            // Check if current user liked
            const { data: likedData, error: likedError } = await sb
                .from('likes')
                .select('user_id')
                .eq('app_id', appState.appId)
                .eq('video_id', MOCK_VIDEO_ID)
                .eq('user_id', appState.userId);
            
            if (likedError) console.error("Error checking user like:", likedError);
            appState.video.isLiked = likedData && likedData.length > 0;
            
            appState.hasLikesLoaded = true;


            // Fetch Comments
            const { data: commentsData, error: commentsError } = await sb
                .from('comments')
                .select('*')
                .eq('app_id', appState.appId)
                .eq('video_id', MOCK_VIDEO_ID)
                .order('created_at', { ascending: false });
            
            if (commentsError) console.error("Error fetching comments:", commentsError);

            if (commentsData) {
                appState.video.comments = commentsData.map(c => ({
                    id: c.id,
                    userId: c.user_id,
                    username: c.username,
                    text: c.text,
                    timestamp: new Date(c.created_at),
                    timestampFormatted: new Date(c.created_at).toLocaleString('ru-RU', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' })
                }));
            } else {
                 appState.video.comments = [];
            }
            
            appState.hasCommentsLoaded = true;
            
            updateVideoUI();
            updateCommentsListUI();
            checkVideoDataReady();
        }
        
        /**
         * --- INTERACTION LOGIC (SUPABASE) ---
         */

        function updateVideoUI() {
            elements.likeCount.textContent = appState.video.likeCount;
            elements.likeWidget.classList.toggle('liked', appState.video.isLiked);
        }

        async function toggleLike() {
            if (!appState.isSupabaseReady) {
                showMessage('–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.', 'tma-red');
                return;
            }
            if (appState.isBanned) {
                showMessage('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏, —Ç–∞–∫ –∫–∞–∫ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–∞–Ω–µ–Ω.', 'tma-red');
                return;
            }

            try {
                if (appState.video.isLiked) {
                    // Delete the like
                    const { error } = await sb
                        .from('likes')
                        .delete()
                        .eq('user_id', appState.userId)
                        .eq('video_id', MOCK_VIDEO_ID)
                        .eq('app_id', appState.appId);

                    if (error) throw error;
                } else {
                    // Add the like
                    const { error } = await sb
                        .from('likes')
                        .insert({ 
                            user_id: appState.userId, 
                            video_id: MOCK_VIDEO_ID, 
                            app_id: appState.appId,
                            created_at: new Date().toISOString()
                        });
                        
                    if (error) throw error;
                }
            } catch (e) {
                console.error("Error toggling like:", e);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ª–∞–π–∫–∞.', 'tma-red');
            }
        }
        
        async function addComment() {
            if (!appState.isSupabaseReady) {
                showMessage('–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.', 'tma-red');
                return;
            }
            if (appState.isBanned) {
                showMessage('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —Ç–∞–∫ –∫–∞–∫ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–∞–Ω–µ–Ω.', 'tma-red');
                return;
            }

            const commentText = elements.commentInput.value.trim();
            if (commentText.length === 0) return;

            try {
                const { error } = await sb
                    .from('comments')
                    .insert({
                        user_id: appState.userId,
                        video_id: MOCK_VIDEO_ID,
                        app_id: appState.appId,
                        username: appState.username,
                        text: commentText,
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                elements.commentInput.value = ''; // Clear input
                showMessage('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω!', 'bg-green-500');
            } catch (e) {
                console.error("Error adding comment:", e);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.', 'tma-red');
            }
        }
        
        function updateCommentsListUI() {
            elements.totalCommentCount.textContent = appState.video.comments.length;
            elements.commentCount.textContent = appState.video.comments.length;
            
            if (appState.video.comments.length === 0) {
                elements.commentList.innerHTML = '<p class="text-center text-gray-500 mt-8">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç!</p>';
                return;
            }

            elements.commentList.innerHTML = appState.video.comments.map(comment => `
                <div class="flex space-x-3 bg-tma-card p-3 rounded-xl shadow-sm">
                    <img class="w-8 h-8 rounded-full" src="https://placehold.co/32x32/179cde/ffffff?text=${comment.username.substring(0,1).toUpperCase()}" alt="Avatar">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <p class="text-sm font-semibold text-gray-800">${comment.username} ${comment.userId === appState.userId ? '<span class="text-tma-primary text-xs font-normal">(–í—ã)</span>' : ''}</p>
                            <span class="text-xs text-gray-400">${comment.timestampFormatted}</span>
                        </div>
                        <p class="text-gray-700 mt-1 text-sm">${comment.text}</p>
                        ${comment.userId === appState.userId && appState.isSupabaseReady ? 
                            `<button class="text-tma-red text-xs mt-1" onclick="deleteComment('${comment.id}')">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            // Scroll to the bottom if comments view is open (for better UX)
            if (elements.commentsView.classList.contains('show-comments')) {
                elements.commentList.scrollTop = elements.commentList.scrollHeight;
            }
        }

        async function deleteComment(commentId) {
            if (!appState.isSupabaseReady) {
                showMessage('–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.', 'tma-red');
                return;
            }
            
            try {
                // Delete: DELETE FROM comments WHERE id = {commentId} AND user_id = {userId} (RLS should enforce this)
                const { error } = await sb
                    .from('comments')
                    .delete()
                    .eq('id', commentId)
                    .eq('user_id', appState.userId); // Ensure only the owner can delete (via client-side check + RLS)

                if (error) throw error;
                showMessage('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω.', 'bg-green-500');
            } catch (e) {
                console.error("Error deleting comment:", e);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.', 'tma-red');
            }
        }

        function openCommentsView() {
            elements.commentsView.classList.add('show-comments');
            // Add history state for comments view (to allow closing with back button)
            history.pushState({ viewId: 'comments' }, '', '#comments');
            // Scroll to bottom on opening
            elements.commentList.scrollTop = elements.commentList.scrollHeight;
        }

        function closeCommentsView() {
            elements.commentsView.classList.remove('show-comments');
            // Go back in history
            if (history.state && history.state.viewId === 'comments') {
                history.back();
            } else {
                 // Fallback if not opened via pushState 
            }
        }

        function updateProfileUI() {
            elements.profileUsername.textContent = appState.username;
            elements.profileUserId.textContent = `ID: ${appState.userId}`;
            elements.adminUserIdDisplay.textContent = appState.userId;
            
            // Verification status
            if (appState.isVerified) {
                elements.verificationStatus.textContent = '‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω';
                elements.verificationStatus.classList.remove('text-gray-500');
                elements.verificationStatus.classList.add('text-tma-primary');
            } else {
                elements.verificationStatus.textContent = '‚ö™ –ù–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω';
                elements.verificationStatus.classList.remove('text-tma-primary');
                elements.verificationStatus.classList.add('text-gray-500');
            }
            
            // Ban status
            elements.banStatus.classList.toggle('hidden', !appState.isBanned);
        }

        function updateAdminView() {
            const isAdmin = appState.userId === ADMIN_USER_ID && appState.isSupabaseReady; 
            elements.adminNavButton.classList.toggle('hidden', !isAdmin);
            
            // If the user IS the admin, we show the admin panel as a 4th tab
            if (isAdmin) {
                document.getElementById('admin-view').style.width = 'calc(100% / 4)'; 
                document.getElementById('admin-view').classList.remove('hidden');
                appState.viewTitles['admin'] = '–ê–¥–º–∏–Ω';
            } else {
                document.getElementById('admin-view').classList.add('hidden');
                delete appState.viewTitles['admin'];
            }
        }
        
        async function updateAdminStatus(targetId, field, status, successMessage) {
            if (!appState.isSupabaseReady) {
                showMessage('–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.', 'tma-red');
                return false;
            }
            if (appState.userId !== ADMIN_USER_ID) {
                showMessage('–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ. –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.', 'tma-red');
                return false;
            }
            if (!targetId) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.', 'tma-red');
                return false;
            }
            
            try {
                // Update: UPDATE users SET {field} = {status} WHERE id = {targetId} AND app_id = {appId}
                const { error } = await sb
                    .from('users')
                    .update({ [field]: status })
                    .eq('id', targetId)
                    .eq('app_id', appState.appId);

                if (error) throw error;
                showMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${targetId.substring(0, 8)}...: ${successMessage}`, 'bg-green-500');
                return true;
            } catch (e) {
                console.error(`Error setting ${field} status:`, e);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞.', 'tma-red');
                return false;
            }
        }

        function setVerificationStatus(status) {
             const targetId = elements.targetUserId.value.trim();
             updateAdminStatus(targetId, 'is_verified', status, status ? '–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω' : '–°–Ω—è—Ç–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è');
        }
        
        function setBanStatus(status) {
            const targetId = elements.targetUserId.value.trim();
            updateAdminStatus(targetId, 'is_banned', status, status ? '–ó–∞–±–∞–Ω–µ–Ω' : '–†–∞–∑–±–∞–Ω–µ–Ω');
        }
        
        function publishVideo() {
            // This is a mock function, remains unchanged as DB logic is complex for upload
            const caption = document.getElementById('caption-input').value.trim();
            if (caption.length < 5) {
                 showMessage('–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 5 —Å–∏–º–≤–æ–ª–æ–≤.', 'tma-red');
                 return;
            }

            showMessage(`–í–∏–¥–µ–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º: "${caption.substring(0, 20)}..." –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ (–º–æ–¥–µ–ª—å).`, 'bg-tma-primary');
            document.getElementById('caption-input').value = '';
            switchView('home');
        }

        // Handle browser back/forward buttons (Remains unchanged)
        window.onpopstate = (event) => {
            const targetViewId = event.state && event.state.viewId ? event.state.viewId : 'home';
            
            if (targetViewId === 'comments') {
                elements.commentsView.classList.add('show-comments');
            } else if (appState.currentViewId === 'comments') {
                elements.commentsView.classList.remove('show-comments');
            }

            if (targetViewId !== 'comments') {
                 if (appState.currentViewId !== targetViewId) {
                    switchView(targetViewId, false);
                 }
            }
        };

        
        // --- APPLICATION ENTRY POINT ---
        window.onload = function () {
            // 1. Collect elements after the DOM is fully loaded
            collectDOMElements();
            
            // 2. Start Supabase initialization and auth check
            initSupabase();
            
            // Make functions available globally for inline HTML event handlers (Remains unchanged)
            window.switchView = switchView;
            window.registerUsername = registerUsername;
            window.toggleLike = toggleLike;
            window.openCommentsView = openCommentsView;
            window.closeCommentsView = closeCommentsView;
            window.addComment = addComment;
            window.deleteComment = deleteComment;
            window.navigateBack = navigateBack;
            window.setVerificationStatus = setVerificationStatus;
            window.setBanStatus = setBanStatus;
            window.publishVideo = publishVideo;
            window.showMessage = showMessage;
        };
    </script>
