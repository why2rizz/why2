<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Feed Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tma-primary': '#007AFF',
                        'tma-bg': '#f5f5f5',
                        'tma-card': '#ffffff',
                        'tma-red': '#FF3B30',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'tma-nav': '0 -4px 6px -1px rgba(0, 0, 0, 0.05), 0 -2px 4px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Общие стили для контейнера приложения */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5; /* tma-bg */
        }

        #main-app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 500px; /* Ограничение ширины для мобильного вида */
            margin: 0 auto;
            position: relative;
            background-color: #000; /* Фон для видео-ленты */
        }

        /* Контейнер для всех видов (для свайпа/сдвига) */
        #content-slider {
            display: flex;
            width: 300%; /* По умолчанию 3 вкладки: Home, Post, Profile */
            height: 100%;
            transition: transform 0.3s ease-out;
            flex-shrink: 0;
        }
        
        /* Ширина каждой вкладки по умолчанию (3 вкладки) */
        .main-view {
            width: calc(100% / 3);
            flex-shrink: 0;
            overflow-y: auto;
            padding-bottom: 70px; /* Отступ для навигации */
        }
        
        /* Адаптация для 4 вкладок, если Админ-панель активна */
        #admin-view:not(.hidden) ~ #content-slider {
            width: 400%;
        }

        #admin-view:not(.hidden),
        #admin-view:not(.hidden) ~ #content-slider .main-view {
            width: calc(100% / 4) !important;
        }


        /* Стили для Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            transition: opacity 0.3s ease;
        }

        /* Комментарии (боковое/нижнее модальное окно) */
        #comments-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            margin: 0 auto;
        }

        #comments-view.show-comments {
            transform: translateY(0);
        }

        #comment-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #ffffff;
        }
        
        /* Видео-Лента */
        #video-feed-container {
             /* Убираем отступы, чтобы видео занимало весь экран */
            padding-bottom: 0px !important; 
        }

        .video-card {
            scroll-snap-align: start;
            /* Убедитесь, что высота равна видимой области (viewport - header - nav) */
            height: calc(100vh - 56px - 70px); 
        }

        .liked .like-icon {
            color: #FF3B30; /* Красное сердце */
            transform: scale(1.1);
            transition: transform 0.1s ease-in;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="splash-screen" class="text-white">
        <div class="spinner border-4 border-t-tma-primary border-solid rounded-full h-10 w-10 mb-4"></div>
        <h1 class="text-xl font-bold">Загрузка</h1>
    </div>
    
    <div id="registration-view" class="fixed inset-0 bg-tma-bg p-6 z-40 hidden flex-col items-center justify-center">
        <div class="bg-tma-card p-6 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Выберите имя</h2>
            <p class="text-sm text-gray-500 mb-4">Это имя будет видно другим пользователям.</p>
            <input type="text" id="username-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-tma-primary" placeholder="Ваше имя">
            <button onclick="registerUsername()" class="w-full mt-4 bg-tma-primary text-white p-3 rounded-lg font-semibold hover:bg-blue-600 transition">Продолжить</button>
        </div>
    </div>

    <div id="main-app-container" class="hidden">
        
        <header class="flex justify-between items-center p-4 bg-tma-card shadow-sm z-30 flex-shrink-0">
            <button id="back-button" onclick="navigateBack()" class="text-tma-primary hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <h1 id="header-title" class="text-lg font-bold text-gray-800 flex-grow text-center">Главная</h1>
            <button id="search-button" class="text-tma-primary">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </button>
        </header>

        <div class="flex-grow overflow-hidden relative">
            <div id="content-slider">
                
                <div id="home-view" class="main-view bg-black">
                    
                    <div id="video-loading-overlay" class="absolute inset-0 bg-gray-900/90 z-10 flex flex-col items-center justify-center text-white text-center p-4">
                        <div class="spinner border-4 border-t-tma-primary border-solid rounded-full h-8 w-8 mb-4"></div>
                        <p class="text-xl font-bold">Загрузка ленты видео...</p>
                    </div>
                    
                    <div id="video-feed-container" class="h-full w-full overflow-y-scroll snap-y snap-mandatory">
                        <p class="text-white text-center mt-20 p-4">Начальная загрузка...</p>
                    </div>
                </div>

                <div id="post-view" class="main-view bg-tma-bg p-4 flex flex-col items-center justify-center">
                    <div class="bg-tma-card p-6 rounded-xl shadow-lg w-full max-w-sm">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Опубликовать Видео</h2>
                        <div class="flex items-center justify-center w-full h-40 border-2 border-dashed border-gray-300 rounded-lg mb-4 text-gray-500">
                            <p>Видео-заглушка (реальная загрузка не реализована)</p>
                        </div>
                        <textarea id="caption-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-tma-primary" rows="3" placeholder="Описание к видео..."></textarea>
                        <button onclick="publishVideo()" class="w-full mt-4 bg-tma-primary text-white p-3 rounded-lg font-semibold hover:bg-blue-600 transition">Опубликовать</button>
                    </div>
                </div>

                <div id="profile-view" class="main-view bg-tma-bg p-4">
                    <div class="bg-tma-card p-6 rounded-xl shadow-lg text-center">
                        <img id="profile-avatar" class="w-24 h-24 rounded-full mx-auto mb-4 bg-tma-primary" src="https://placehold.co/96x96/007AFF/ffffff?text=U" alt="Profile Avatar">
                        <h2 id="profile-username" class="text-2xl font-bold text-gray-800">Пользователь</h2>
                        <p id="profile-userid" class="text-sm text-gray-500 mb-4">ID: ...</p>
                        
                        <div class="space-y-3 mt-4">
                            <p id="verification-status" class="text-lg font-medium text-gray-500">⚪ Не верифицирован</p>
                            <p id="ban-status" class="text-lg font-medium text-tma-red hidden">❌ ЗАБАНЕН</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-tma-card rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Статистика</h3>
                        <p class="text-gray-600">Опубликовано видео: <span class="font-bold">0</span></p>
                        <p class="text-gray-600">Общее количество лайков: <span class="font-bold">0</span></p>
                    </div>
                </div>
                
                <div id="admin-view" class="main-view bg-tma-bg p-4 hidden">
                    <div class="bg-tma-card p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Панель Администратора</h2>
                        <p class="text-sm text-gray-500 mb-4">Ваш ID: <span id="admin-user-id-display" class="font-mono text-xs">...</span></p>
                        
                        <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-800">Управление пользователем</h3>
                        <input type="text" id="target-user-id" class="w-full p-2 border border-gray-300 rounded-lg mb-3" placeholder="ID пользователя (UUID)">
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="setVerificationStatus(true)" class="bg-green-500 text-white p-3 rounded-lg text-sm">Верифицировать</button>
                            <button onclick="setVerificationStatus(false)" class="bg-gray-400 text-white p-3 rounded-lg text-sm">Снять верификацию</button>
                            <button onclick="setBanStatus(true)" class="bg-tma-red text-white p-3 rounded-lg text-sm">Забанить</button>
                            <button onclick="setBanStatus(false)" class="bg-tma-primary text-white p-3 rounded-lg text-sm">Разбанить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <nav class="flex justify-around items-center h-16 bg-tma-card border-t shadow-tma-nav flex-shrink-0 z-30">
            
            <a href="#" onclick="switchView('home')" class="nav-item flex flex-col items-center p-2 text-tma-primary" data-view-id="home">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                <span class="text-xs">Главная</span>
            </a>
            
            <a href="#" onclick="switchView('post')" class="nav-item flex flex-col items-center p-2 text-gray-500" data-view-id="post">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                <span class="text-xs">Пост</span>
            </a>
            
            <a href="#" onclick="switchView('profile')" class="nav-item flex flex-col items-center p-2 text-gray-500" data-view-id="profile">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                <span class="text-xs">Профиль</span>
            </a>
            
            <a href="#" id="admin-nav-button" onclick="switchView('admin')" class="nav-item flex flex-col items-center p-2 text-gray-500 hidden" data-view-id="admin">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 6h2v2h-2V7zm0 4h2v6h-2v-6z"/></svg>
                <span class="text-xs">Админ</span>
            </a>
        </nav>
        
        <div id="message-box" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white font-medium text-sm shadow-xl opacity-0 pointer-events-none transition-all duration-300 z-50 bg-green-500">
            Сообщение
        </div>

        <div id="error-message" class="fixed top-16 left-0 w-full bg-tma-red text-white text-center p-2 text-sm z-40 hidden">
            Приложение работает в ограниченном режиме (ошибка подключения к базе данных).
        </div>
    </div>
    
    <div id="comments-view">
        <div class="h-12 bg-tma-card flex items-center justify-between p-4 flex-shrink-0 shadow-sm">
            <h2 class="text-lg font-bold text-gray-800">Комментарии (<span id="total-comment-count">0</span>)</h2>
            <button onclick="closeCommentsView()" class="text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div id="comment-list" class="flex-grow overflow-y-auto space-y-3">
            </div>
        
        <form id="comment-form" onsubmit="addComment(); return false;" class="p-4 bg-tma-card flex-shrink-0 border-t shadow-lg">
            <input type="text" id="comment-input" class="flex-grow p-3 border border-gray-300 rounded-l-lg w-full focus:outline-none focus:ring-2 focus:ring-tma-primary" placeholder="Ваш комментарий...">
            <button type="submit" class="w-full mt-2 bg-tma-primary text-white p-3 rounded-lg font-semibold hover:bg-blue-600 transition">Отправить</button>
        </form>
    </div>


    <script>
        
        // --- КОНФИГУРАЦИЯ SUPABASE (ЗАМЕНИТЕ НА СВОИ ЗНАЧЕНИЯ!) ---
        const SUPABASE_URL = "https://qpdyhdvrkampgigddizx.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwZHloZHZya2FtcGdpZ2RkaXp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDA4ODcsImV4cCI6MjA3NTQxNjg4N30.eBKi2hQ6pe-CN1_pqigrOwvWt6PAqeSJ0X7RdSIweS8"; 
        // -------------------------------------------------------------

        // Global State and Constants
        const ADMIN_USER_ID = '8098423493'; // Ваш ID для доступа к админке (только число)

        // --- Безопасное получение имени пользователя из Telegram ---
        let tgUsername = 'Пользователь TG';
        let tgUserId = null;

        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
            const user = window.Telegram.WebApp.initDataUnsafe.user;
            const tgFirstName = user.first_name || 'Пользователь';
            const tgLastName = user.last_name || '';
            tgUsername = tgFirstName + (tgLastName ? ' ' + tgLastName : '');
            tgUserId = user.id.toString(); 
        }
        // -----------------------------------------------------------


        let appState = {
            userId: null,
            username: tgUsername, 
            isVerified: false,
            isBanned: false,
            status: 'loading', 
            isSupabaseReady: false, // Изменено
            hasVideoDataLoaded: false, 
            
            videos: [], // Список всех видео
            currentVideoIndex: 0, // Индекс активного видео
            
            currentViewId: 'home',
            viewMap: { 'home': 0, 'post': 1, 'profile': 2, 'admin': 3 },
            viewTitles: { 'home': 'Главная', 'post': 'Публикация', 'profile': 'Профиль', 'admin': 'Админ' }
        };

        // Global Supabase Client Reference
        let supabase = null; 
        
        // Объект для хранения ссылок на DOM-элементы
        let elements = {}; 

        
        /**
         * --- VIEW CONTROL ---
         */

        function collectDOMElements() {
            // ... (все элементы DOM, как и раньше) ...
            elements.splashScreen = document.getElementById('splash-screen');
            elements.registrationView = document.getElementById('registration-view');
            elements.mainAppContainer = document.getElementById('main-app-container');
            elements.contentSlider = document.getElementById('content-slider');
            elements.commentsView = document.getElementById('comments-view');
            elements.headerTitle = document.getElementById('header-title');
            elements.backButton = document.getElementById('back-button');
            elements.searchButton = document.getElementById('search-button');
            elements.adminNavButton = document.getElementById('admin-nav-button');
            elements.navItems = document.querySelectorAll('.nav-item');
            elements.messageBox = document.getElementById('message-box');
            elements.errorMessage = document.getElementById('error-message');

            elements.usernameInput = document.getElementById('username-input');

            // Profile elements
            elements.profileUsername = document.getElementById('profile-username');
            elements.profileUserId = document.getElementById('profile-userid');
            elements.verificationStatus = document.getElementById('verification-status');
            elements.banStatus = document.getElementById('ban-status');
            elements.profileAvatar = document.getElementById('profile-avatar');
            elements.adminUserIdDisplay = document.getElementById('admin-user-id-display');
            elements.targetUserId = document.getElementById('target-user-id');

            // Video elements
            elements.videoFeedContainer = document.getElementById('video-feed-container'); 
            elements.videoLoadingOverlay = document.getElementById('video-loading-overlay'); 

            // Comments elements
            elements.totalCommentCount = document.getElementById('total-comment-count');
            elements.commentList = document.getElementById('comment-list');
            elements.commentInput = document.getElementById('comment-input');
        }


        function switchView(viewId, updateHistory = true) {
            if (appState.isBanned && viewId !== 'profile') {
                showMessage('Вы забанены и можете просматривать только свой профиль.', 'tma-red');
                viewId = 'profile';
            }

            const index = appState.viewMap[viewId];
            if (index === undefined) return;
            
            appState.currentViewId = viewId;

            // 1. Move the slider (логика исправления вкладок сохранена)
            const totalViews = document.querySelectorAll('.main-view:not(.hidden)').length;
            elements.contentSlider.style.transform = `translateX(-${index * (100 / totalViews)}%)`;

            // 2. Update navigation bar active state
            elements.navItems.forEach(item => {
                const isCurrent = item.getAttribute('data-view-id') === viewId;
                item.classList.toggle('text-tma-primary', isCurrent);
                item.classList.toggle('text-gray-500', !isCurrent);
            });

            // 3. Update header title
            updateHeader(appState.viewTitles[viewId]);

            // 4. Update history (for back button)
            if (updateHistory) {
                if (history.state && history.state.viewId === 'comments' && viewId !== 'comments') {
                    history.go(-1);
                }
                history.pushState({ viewId: viewId }, '', `#${viewId}`);
            }
        }

        function updateHeader(title, showBack = false) {
            elements.headerTitle.textContent = title;
            elements.backButton.classList.toggle('hidden', !showBack);
            elements.searchButton.classList.toggle('hidden', showBack); 
        }

        function navigateBack() {
            if (elements.commentsView.classList.contains('show-comments')) {
                closeCommentsView();
            } else {
                history.back();
            }
        }

        function showMessage(message, bgColor) {
            elements.messageBox.textContent = message;
            const colorClass = bgColor.startsWith('tma-') ? `bg-${bgColor}` : bgColor;
            elements.messageBox.className = `fixed bottom-20 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white font-medium text-sm shadow-xl transition-all duration-300 z-50 ${colorClass}`;
            
            elements.messageBox.classList.remove('opacity-0', 'pointer-events-none');
            
            setTimeout(() => {
                elements.messageBox.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }
        /**
         * --- INITIALIZATION FLOW CONTROL ---
         */

        function checkVideoDataReady() {
            if (appState.videos.length > 0 && !appState.hasVideoDataLoaded) {
                 elements.videoLoadingOverlay.classList.add('hidden');
                 appState.hasVideoDataLoaded = true;
            }
        }

        function hideSplashAndShowMainApp() {
            elements.splashScreen.classList.add('hidden');
            elements.mainAppContainer.classList.remove('hidden');
            switchView('home', false); 
            updateProfileUI(); 
            updateAdminView();
        }

        function startLimitedMode() {
            appState.status = 'limited';
            appState.isSupabaseReady = false;
            appState.userId = tgUserId || 'mock-user-' + Math.random().toString(36).substring(2, 8); 
            
            elements.errorMessage.classList.remove('hidden');
            elements.splashScreen.classList.add('hidden');
            elements.mainAppContainer.classList.remove('hidden');
            switchView('home', false);
            updateProfileUI();
            updateAdminView();
            
            elements.videoLoadingOverlay.classList.add('hidden'); 
            appState.hasVideoDataLoaded = true;
            showMessage('Приложение работает в ограниченном режиме (нет доступа к базе данных).', 'bg-red-500');
            
            // Отключение интерактивных функций
            const limitedModeHandler = (e) => { 
                if(e) e.preventDefault();
                showMessage('Функция недоступна в ограниченном режиме.', 'tma-red'); 
                return false; 
            };
            document.getElementById('comment-form').onsubmit = limitedModeHandler;
            document.getElementById('post-view').querySelector('button').onclick = limitedModeHandler;
        }

        /**
         * --- SUPABASE AND AUTHENTICATION ---
         */
        
        function initSupabase() {
            if (!window.supabase) {
                console.error("Supabase SDK not loaded. Starting limited mode.");
                startLimitedMode();
                return;
            }
            
            try {
                // Инициализация Supabase Client
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                appState.isSupabaseReady = true;

                // Используем ID пользователя Telegram в качестве основного ID
                if (tgUserId) {
                    appState.userId = tgUserId;
                    fetchAndListenForUserAccount();
                } else {
                     // Fallback для случая вне контекста Telegram
                     console.warn("Telegram User ID not available. Using mock ID for limited functionality.");
                     appState.userId = 'mock-' + Math.random().toString(36).substring(2, 8); 
                     fetchAndListenForUserAccount();
                }

            } catch (error) {
                console.error("Supabase Initialization Failed:", error);
                startLimitedMode();
            }
        }

        async function fetchAndListenForUserAccount() {
            if (!appState.isSupabaseReady) return;

            try {
                // 1. Пытаемся получить пользователя
                const { data: userData, error: fetchError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', appState.userId)
                    .single();

                // 2. Если пользователь не найден (ошибка PGRST116), регистрируем его
                if (fetchError && fetchError.code === 'PGRST116') { 
                    const { error: insertError } = await supabase
                        .from('users')
                        .insert({
                            id: appState.userId,
                            username: appState.username, 
                            is_verified: false,
                            is_banned: false,
                        });

                    if (insertError) throw insertError;
                    // Используем дефолтные значения appState
                } else if (fetchError) {
                    throw fetchError;
                } else if (userData) {
                    // Пользователь найден, обновляем appState
                    appState.isVerified = userData.is_verified || false;
                    appState.isBanned = userData.is_banned || false;
                    appState.username = userData.username || appState.username; 
                }
                
                // Запускаем слушателей в реальном времени
                setupRealtimeListeners(); 
                // Загружаем ленту видео
                await fetchVideosFromSupabase(false);
                hideSplashAndShowMainApp();
                
            } catch (e) {
                console.error("Supabase User Setup Error:", e);
                startLimitedMode();
            }
        }
        
        /**
         * Устанавливает слушатели Supabase Realtime.
         */
        function setupRealtimeListeners() {
            if (!appState.isSupabaseReady) return;

            // 1. User Profile Listener (слушаем только изменения в нашем профиле)
            supabase
                .from(`users:id=eq.${appState.userId}`)
                .on('UPDATE', (payload) => {
                    const newStatus = payload.new;
                    appState.isVerified = newStatus.is_verified || false;
                    appState.isBanned = newStatus.is_banned || false;
                    appState.username = newStatus.username || appState.username;
                    updateProfileUI();

                    if (appState.isBanned) {
                        showMessage('Ваш аккаунт был забанен.', 'tma-red');
                        if (appState.currentViewId !== 'profile') {
                             switchView('profile');
                        }
                    }
                })
                .subscribe();
            
            // 2. Videos Feed Listener (слушаем любые изменения в таблице videos)
            supabase
                .from('videos')
                .on('*', async (payload) => {
                    // При любом изменении (INSERT, UPDATE, DELETE) перечитываем все видео
                    await fetchVideosFromSupabase(true); 
                    checkVideoDataReady();
                })
                .subscribe();
        }

        // Новая функция для первичной и повторной загрузки видео
        async function fetchVideosFromSupabase(isUpdate = false) {
            const { data: videosData, error } = await supabase
                .from('videos')
                .select('*')
                .order('created_at', { ascending: false }); 

            if (error) {
                console.error("Error fetching videos:", error);
                return;
            }
            
            appState.videos = videosData.map(video => ({
                id: video.id,
                authorId: video.author_id,
                username: video.username,
                caption: video.caption,
                videoUrl: video.video_url,
                timestamp: new Date(video.created_at), // Supabase возвращает ISO-строку
                isLiked: false, 
                likeCount: 0, 
                comments: []
            }));

            if (appState.videos.length > 0) {
                renderVideoFeed(appState.videos);
                // При загрузке или обновлении ленты, загружаем данные для активного видео
                await fetchLikesAndCommentsForActiveVideo(); 
            } else {
                 elements.videoFeedContainer.innerHTML = '<div class="text-white text-center mt-20 p-4">Пока нет ни одного видео. Создайте первое!</div>';
            }
        }

        
        // Debounce function to limit scroll event frequency
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        /**
         * Генерирует HTML-код ленты и устанавливает обработчик прокрутки.
         */
        function renderVideoFeed(videos) {
            elements.videoFeedContainer.innerHTML = videos.map((video, index) => `
                <div id="video-card-${video.id}" class="video-card h-full w-full relative snap-start">
                    
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-white text-center p-4 bg-gray-900">
                        <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        <p class="font-light">Видео №${index + 1}</p>
                        <p class="text-xl font-bold mt-2">@${video.username}</p>
                    </div>

                    <div class="absolute bottom-4 left-4 right-20 text-white z-20">
                        <p class="font-semibold text-lg">@${video.username}</p>
                        <p class="text-sm mt-1">${video.caption}</p>
                    </div>

                    <div class="absolute bottom-20 right-4 flex flex-col items-center space-y-6 text-white z-20">
                        
                        <div id="like-widget-${video.id}" class="like-widget flex flex-col items-center cursor-pointer select-none" 
                            onclick="toggleLike('${video.id}')">
                            <svg class="like-icon w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            <span id="like-count-${video.id}" class="text-sm font-semibold mt-1">0</span>
                        </div>
                        
                        <div id="comment-widget-${video.id}" class="comment-widget flex flex-col items-center cursor-pointer select-none" 
                            onclick="openCommentsView('${video.id}')">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                            <span id="comment-count-${video.id}" class="text-sm font-semibold mt-1">0</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Устанавливаем обработчик прокрутки для определения активного видео
            elements.videoFeedContainer.onscroll = debounce(handleVideoScroll, 100);
        }

        /**
         * Обрабатывает прокрутку и определяет активное видео.
         */
        function handleVideoScroll() {
            const container = elements.videoFeedContainer;
            const scrollPosition = container.scrollTop;
            const videoHeight = container.clientHeight;
            
            // Определяем индекс видео, которое занимает большую часть экрана
            const newIndex = Math.round(scrollPosition / videoHeight);

            if (newIndex !== appState.currentVideoIndex && newIndex >= 0 && newIndex < appState.videos.length) {
                appState.currentVideoIndex = newIndex;
                fetchLikesAndCommentsForActiveVideo();
            }
        }
        
        /**
         * Получает лайки и комментарии только для активного видео из Supabase.
         */
        async function fetchLikesAndCommentsForActiveVideo() {
            if (appState.videos.length === 0 || !appState.isSupabaseReady) return;

            const video = appState.videos[appState.currentVideoIndex];
            const videoId = video.id;

            // 1. Get Likes
            const { data: likesData, error: likesError } = await supabase
                .from('video_likes')
                .select('user_id') 
                .eq('video_id', videoId);

            if (likesError) console.error("Error fetching likes:", likesError);

            video.likeCount = likesData ? likesData.length : 0;
            video.isLiked = likesData ? likesData.some(item => item.user_id === appState.userId) : false;

            // 2. Get Comments
            const { data: commentsData, error: commentsError } = await supabase
                .from('video_comments')
                .select('*')
                .eq('video_id', videoId)
                .order('created_at', { ascending: false });

            if (commentsError) console.error("Error fetching comments:", commentsError);

            video.comments = commentsData ? commentsData.map(c => ({
                id: c.id, 
                userId: c.user_id,
                username: c.username,
                text: c.text,
                timestamp: new Date(c.created_at), 
            })).map(c => {
                 c.timestampFormatted = c.timestamp.toLocaleString('ru-RU', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
                 return c;
            }) : [];

            // 3. Обновление UI для активного видео
            updateActiveVideoUI(video);
            // Если комментарии открыты, обновляем их список
            if (elements.commentsView.classList.contains('show-comments')) {
                 updateCommentsListUI(); 
            }
        }

        /**
         * Обновляет виджеты Лайков и Комментариев для текущего активного видео.
         */
        function updateActiveVideoUI(video) {
            const likeCountEl = document.getElementById(`like-count-${video.id}`);
            const likeWidgetEl = document.getElementById(`like-widget-${video.id}`);
            const commentCountEl = document.getElementById(`comment-count-${video.id}`);
            
            if (likeCountEl) likeCountEl.textContent = video.likeCount;
            if (commentCountEl) commentCountEl.textContent = video.comments.length;
            
            if (likeWidgetEl) {
                likeWidgetEl.classList.toggle('liked', video.isLiked);
            }
        }


        /**
         * --- INTERACTION LOGIC (SUPABASE) ---
         */

        async function toggleLike(videoId) {
            if (!appState.isSupabaseReady || appState.isBanned) {
                showMessage('Действие недоступно.', 'tma-red');
                return;
            }

            const video = appState.videos.find(v => v.id === videoId);
            if (!video) return;

            try {
                if (video.isLiked) {
                    // Удаляем лайк
                    const { error } = await supabase
                        .from('video_likes')
                        .delete()
                        .eq('video_id', videoId)
                        .eq('user_id', appState.userId);
                    
                    if (error) throw error;
                    showMessage('Лайк убран.', 'bg-gray-500');
                } else {
                    // Добавляем лайк
                    const { error } = await supabase
                        .from('video_likes')
                        .insert({ 
                            video_id: videoId, 
                            user_id: appState.userId 
                        });
                    
                    if (error) throw error;
                    showMessage('Лайк поставлен! ❤️', 'bg-tma-red');
                }
                // Принудительно обновляем данные для активного видео
                await fetchLikesAndCommentsForActiveVideo();
            } catch (e) {
                console.error("Error toggling like:", e);
                showMessage('Ошибка при обновлении лайка. Проверьте RLS-правила.', 'tma-red');
            }
        }
        
        async function addComment() {
            if (!appState.isSupabaseReady || appState.isBanned || appState.videos.length === 0) {
                showMessage('Действие недоступно.', 'tma-red');
                return;
            }

            const commentText = elements.commentInput.value.trim();
            const activeVideo = appState.videos[appState.currentVideoIndex];
            if (commentText.length === 0 || !activeVideo) return;

            try {
                const { error } = await supabase
                    .from('video_comments')
                    .insert({
                        video_id: activeVideo.id,
                        user_id: appState.userId,
                        username: appState.username,
                        text: commentText,
                    });
            
                if (error) throw error;

                elements.commentInput.value = ''; 
                showMessage('Комментарий добавлен!', 'bg-green-500');
                // Обновляем данные для активного видео
                await fetchLikesAndCommentsForActiveVideo();
            } catch (e) {
                console.error("Error adding comment:", e);
                showMessage('Ошибка при добавлении комментария. Проверьте RLS-правила.', 'tma-red');
            }
        }
        
        function updateCommentsListUI() {
            const activeVideo = appState.videos[appState.currentVideoIndex];
            const comments = activeVideo ? activeVideo.comments : [];

            elements.totalCommentCount.textContent = comments.length;
            
            if (comments.length === 0) {
                elements.commentList.innerHTML = '<p class="text-center text-gray-500 mt-8">Будьте первым, кто прокомментирует!</p>';
                return;
            }

            elements.commentList.innerHTML = comments.map(comment => `
                <div class="flex space-x-3 bg-tma-card p-3 rounded-xl shadow-sm">
                    <img class="w-8 h-8 rounded-full" src="https://placehold.co/32x32/179cde/ffffff?text=${comment.username.substring(0,1).toUpperCase()}" alt="Avatar">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <p class="text-sm font-semibold text-gray-800">${comment.username} ${comment.userId === appState.userId ? '<span class="text-tma-primary text-xs font-normal">(Вы)</span>' : ''}</p>
                            <span class="text-xs text-gray-400">${comment.timestampFormatted}</span>
                        </div>
                        <p class="text-gray-700 mt-1 text-sm">${comment.text}</p>
                        ${comment.userId === appState.userId && appState.isSupabaseReady ? 
                            `<button class="text-tma-red text-xs mt-1" onclick="deleteComment('${comment.id}')">Удалить</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            if (elements.commentsView.classList.contains('show-comments')) {
                elements.commentList.scrollTop = elements.commentList.scrollHeight;
            }
        }

        async function deleteComment(commentId) {
            if (!appState.isSupabaseReady || appState.videos.length === 0) {
                showMessage('Функция недоступна в ограниченном режиме.', 'tma-red');
                return;
            }

            try {
                const { error } = await supabase
                    .from('video_comments')
                    .delete()
                    .eq('id', commentId)
                    .eq('user_id', appState.userId); // Убедимся, что удаляем только свой комментарий

                if (error) throw error;
                
                showMessage('Комментарий удален.', 'bg-green-500');
                await fetchLikesAndCommentsForActiveVideo();
            } catch (e) {
                console.error("Error deleting comment:", e);
                showMessage('Ошибка при удалении комментария. Проверьте RLS-правила.', 'tma-red');
            }
        }

        function openCommentsView(videoId) {
            const index = appState.videos.findIndex(v => v.id === videoId);
            if (index !== -1) {
                appState.currentVideoIndex = index;
                updateCommentsListUI(); 
            }

            elements.commentsView.classList.add('show-comments');
            history.pushState({ viewId: 'comments' }, '', '#comments');
            elements.commentList.scrollTop = elements.commentList.scrollHeight;
        }

        function closeCommentsView() {
            elements.commentsView.classList.remove('show-comments');
            if (history.state && history.state.viewId === 'comments') {
                history.back();
            }
        }

        // --- УПРАВЛЕНИЕ ПРОФИЛЕМ ---
        function updateProfileUI() {
            elements.profileUsername.textContent = appState.username; 
            elements.profileUserId.textContent = `ID: ${appState.userId}`;
            elements.adminUserIdDisplay.textContent = appState.userId;
            
            const firstLetter = appState.username.substring(0,1).toUpperCase();
            elements.profileAvatar.src = `https://placehold.co/96x96/007AFF/ffffff?text=${firstLetter}`;
            
            if (appState.isVerified) {
                elements.verificationStatus.textContent = '✅ Верифицирован';
                elements.verificationStatus.classList.remove('text-gray-500');
                elements.verificationStatus.classList.add('text-tma-primary');
            } else {
                elements.verificationStatus.textContent = '⚪ Не верифицирован';
                elements.verificationStatus.classList.remove('text-tma-primary');
                elements.verificationStatus.classList.add('text-gray-500');
            }
            
            elements.banStatus.classList.toggle('hidden', !appState.isBanned);
        }

        function updateAdminView() {
            const isAdmin = appState.userId === ADMIN_USER_ID && appState.isSupabaseReady; 
            elements.adminNavButton.classList.toggle('hidden', !isAdmin);
            
            const adminViewEl = document.getElementById('admin-view');
            
            const views = document.querySelectorAll('.main-view');
            
            if (isAdmin) {
                adminViewEl.classList.remove('hidden');
                elements.contentSlider.style.width = '400%';
                views.forEach(view => { view.style.width = 'calc(100% / 4)'; });
                appState.viewTitles['admin'] = 'Админ';
            } else {
                adminViewEl.classList.add('hidden');
                elements.contentSlider.style.width = '300%';
                views.forEach(view => { view.style.width = 'calc(100% / 3)'; });
                delete appState.viewTitles['admin'];
            }
        }
        
        // --- АДМИН-ФУНКЦИИ (SUPABASE) ---
        async function setVerificationStatus(status) {
            if (!appState.isSupabaseReady || appState.userId !== ADMIN_USER_ID) {
                showMessage('Отказано в доступе.', 'tma-red');
                return;
            }
            const targetId = elements.targetUserId.value.trim();
            if (!targetId) {
                showMessage('Введите ID пользователя.', 'tma-red');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ is_verified: status })
                    .eq('id', targetId);

                if (error) throw error;
                
                const action = status ? 'Верифицирован' : 'Снята верификация';
                showMessage(`Пользователь ${targetId.substring(0, 8)}...: ${action}`, 'bg-green-500');
            } catch (e) {
                console.error("Error setting verification status:", e);
                showMessage('Ошибка при обновлении статуса. Проверьте ID или RLS-правила.', 'tma-red');
            }
        }
        
        async function setBanStatus(status) {
            if (!appState.isSupabaseReady || appState.userId !== ADMIN_USER_ID) {
                showMessage('Отказано в доступе.', 'tma-red');
                return;
            }
            const targetId = elements.targetUserId.value.trim();
            if (!targetId) {
                showMessage('Введите ID пользователя.', 'tma-red');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ is_banned: status })
                    .eq('id', targetId);

                if (error) throw error;

                const action = status ? 'Забанен' : 'Разбанен';
                showMessage(`Пользователь ${targetId.substring(0, 8)}...: ${action}`, 'bg-green-500');
            } catch (e) {
                console.error("Error setting ban status:", e);
                showMessage('Ошибка при обновлении статуса. Проверьте ID или RLS-правила.', 'tma-red');
            }
        }
        
        /**
         * ЛОГИКА: Добавление видео в Supabase
         */
        async function publishVideo() {
            if (!appState.isSupabaseReady) {
                showMessage('Функция недоступна в ограниченном режиме.', 'tma-red');
                return;
            }
            if (appState.isBanned) {
                showMessage('Вы не можете публиковать видео, так как ваш аккаунт забанен.', 'tma-red');
                return;
            }

            const caption = document.getElementById('caption-input').value.trim();
            if (caption.length < 5) {
                 showMessage('Описание должно быть длиннее 5 символов.', 'tma-red');
                 return;
            }
            
            try {
                const { error } = await supabase
                    .from('videos')
                    .insert({
                        author_id: appState.userId,
                        username: appState.username,
                        caption: caption,
                        video_url: 'https://mock.url/placeholder.mp4', 
                    });
                
                if (error) throw error;
                
                showMessage(`Видео опубликовано!`, 'bg-tma-primary');
                document.getElementById('caption-input').value = '';
                switchView('home');
            } catch (e) {
                console.error("Error publishing video:", e);
                showMessage('Ошибка при публикации видео. Проверьте RLS-правила.', 'tma-red');
            }
        }
        
        window.onpopstate = (event) => {
            const targetViewId = event.state && event.state.viewId ? event.state.viewId : 'home';
            
            if (targetViewId === 'comments') {
                elements.commentsView.classList.add('show-comments');
            } else if (appState.currentViewId === 'comments') {
                elements.commentsView.classList.remove('show-comments');
            }

            if (targetViewId !== 'comments') {
                 if (appState.currentViewId !== targetViewId) {
                    switchView(targetViewId, false);
                 }
            }
        };
        
        // --- APPLICATION ENTRY POINT ---
        window.onload = function () {
            collectDOMElements();
            initSupabase(); // Используем Supabase
            
            // Make functions available globally for inline HTML event handlers
            window.switchView = switchView;
            window.toggleLike = toggleLike;
            window.openCommentsView = openCommentsView;
            window.closeCommentsView = closeCommentsView;
            window.addComment = addComment;
            window.deleteComment = deleteComment;
            window.navigateBack = navigateBack;
            window.setVerificationStatus = setVerificationStatus;
            window.setBanStatus = setBanStatus;
            window.publishVideo = publishVideo;
            window.showMessage = showMessage;
        };
    </script>
</body>
</html>

